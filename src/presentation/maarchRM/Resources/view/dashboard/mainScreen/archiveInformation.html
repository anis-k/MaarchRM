<div id="archiveInformation" class="row" data-children-archive-profiles="[?merge archivalProfileList.json() ?]" data-accept-without-profile="[?mergeacceptArchiveWithoutProfile ?]" >
    <input class="archiveInformationId hide" value="[?merge archive.archiveId ?]">
    <input class="archiveName hide" value="[?merge archive.archiveName ?]">
    <input class="originatorArchiveId hide" value="[?merge archive.originatorArchiveId ?]">
    <input class="originatingDate hide" value="[?merge archive.originatingDate ?]">

    <div class="col-xs-12 text-center">
        <i class="infoIcon fa [?merge archive.fileplanLevel.ifeq('item').then('fa-file', 'fa-archive') ?]" style="[?merge status.ifeq('frozen').then('color: #69B5DB', '') ?]"/>
    </div>
    <div class="col-xs-12">
        <h4 class="text-center text-info">
            <?merge archive.archivalProfileName ?>
            <?merge modificationPrivilege.bool() ?>
            <button type="button" class="btn btn-default btn-sm" id="editMetadata" title="Edit" style="border:0px solid transparent"><i class="fa fa-edit"></i></button>
        </h4>
        <table>
            <tr class="archiveName">
                <th title="Name">Name</th>
                <td title='[?merge archive.archiveName ?]'><?merge archive.archiveName ?></td>
            </tr>
            <tr class="originatorArchiveId">
                <th title="Originator archive identifier">Originator archive identifier</th>
                <td title='[?merge archive.originatorArchiveId ?]'><?merge archive.originatorArchiveId ?></td>
            </tr>
            <tr class="originatingDate">
                <th title="Originating date">Originating date</th>
                <td title='[?merge archive.originatingDate ?]'><?merge archive.originatingDate ?></td>
            </tr>
        </table>
        <div id="metadata">
        </div>
        <?merge acceptUserIndex ?>
        <div class="dropup col-xs-12" id="archiveCustomFieldAddBtn" style="display: none">
            <button type="button" class="btn btn-sm btn-link pull-right" title="Add field" data-toggle="dropdown">
                &nbsp;<i class="fa fa-plus">&nbsp;</i>Add field
            </button>
            <ul class="dropdown-menu pull-right metadataList" aria-labelledby="dLabel">
                <li><a href='#' class="addCustomField" data-type="text">Text</a></li>
                <li><a href='#' class="addCustomField" data-type="date">Date</a></li>
            </ul>
        </div>
        <!--<div id="metadata" class="panel-collapse collapse" role="tabpanel"></div>-->
        <button type="button" class="pull-right btn btn-default btn-sm" id="saveMetadata" title="Save" style="border:0px solid transparent; display: none"><i class="fa fa-check" style="color: green"></i></button>
        <button type="button" class="pull-right btn btn-default btn-sm" id="cancelMetadataEdition" title="Cancel" style="border:0px solid transparent; display: none" ><i class="fa fa-reply" style="color: red"></i></button>
    </div>
    <div class="col-xs-12">
        <div class="panel-group" id="archiveDetails" role="tablist" aria-multiselectable="true">
            <div class="panel-heading text-center" role="tab">
                <strong>
                    <a role="button" data-toggle="collapse" href="#managementInfo" >
                        <span class="text-info">Management information</span>
                    </a>
                    <!--<?merge managementPrivilege.bool() ?>-->
                    <!--<button type="button" class="btn btn-default btn-sm" id="editManagementMetadata" title="Edit" style="border:0px solid transparent"><i class="fa fa-edit"></i></button>-->
                    <!--<a href="#" class="unfreeze [?merge status.ifne('frozen').then('hide', '') ?]" data-type="unfreeze" title="Unfreeze"><i class="fa fa-unlock"></i></a>
                    <a href="#" class="freeze [?merge status.ifeq('frozen').then('hide', '') ?]" data-type="freeze" title="Freeze"><i class="fa fa-lock"></i></a>-->
                </strong>
            </div>
            <div id="managementInfo" class="panel-collapse collapse" role="tabpanel">
                <table>
                    <tr class="originator">
                        <th title="Originator">Originator</th>
                        <td title='[?merge archive.originatorOrgName ?]'><?merge archive.originatorOrgName ?></td>
                    </tr>
                    <tr class="archiveId">
                        <th title="Identifier">Identifier</th>
                        <td title='[?merge archive.archiveId ?]'><?merge archive.archiveId ?></td>
                    </tr>
                    <tr>
                        <th title="Deposit date">Deposit date</th>
                        <td title='[?merge archive.depositDate ?]'><?merge archive.depositDate ?></td>
                    </tr>
                    <tr id="disposalDate">
                        <th title="Disposal date">Disposal date</th>
                        <td title='[?merge archive.disposalDate ?]'><?merge archive.disposalDate ?></td>
                    </tr>
                    <tr id="finalDisposition">
                        <th title="Final disposition">Final disposition</th>
                        <td title='[?merge archive.finalDisposition ?]'><?merge archive.finalDisposition ?></td>
                    </tr>
                    <tr>
                        <th title="Status">Status</th>
                        <td title='[?merge archive.status ?]'><?merge archive.status ?></td>
                    </tr>
                    <tr id="retentionRuleSelect" style="border:0px solid transparent; display: none">
                    <input id="inputRetentionRuleCode" class="hide" value="[?merge archive.retentionRuleCode ?]"/>
                        <th title="Retention rule">Retention rule</th>
                        <td>
                            <select id="retentionRuleCode" name="retentionRuleCode" class="col-xs-12">
                                <option value=''>Select a retention rule</option>
                                <?merge retentionRules ?>
                                <option value='[?merge .code ?]' data-duration="[?merge .durationText ?]" data-finaldisposition="[?merge .finalDisposition ?]"><?merge .label ?></option>
                            </select>
                        </td>
                    </tr>
                    <tr id="startDate" style="border:0px solid transparent; display: none">
                        <th title="Start date">Start date</th>
                        <td>
                            <input type="text" class="datePicker startDate col-xs-12" name="startDate" placeholder="Start date" value="[?merge archive.retentionStartDate ?]"/>
                        </td>
                    </tr>
                </table>

                <table>
                    <?merge archive.accessRuleComDate.bool() ?>
                    <tr>
                        <th title="Communication date">Communication date</th>
                        <td id="accessRuleComDate" title="[?merge archive.accessRuleComDate ?]"><?merge archive.accessRuleComDate ?></td>
                    </tr>
                    <?merge archive.lastCheckDate.bool() ?>
                    <tr>
                        <th title="Last check date">Last check date</th>
                        <td id="lastCheckDate" title="[?merge archive.lastCheckDate ?]"><?merge archive.lastCheckDate ?></td>
                    </tr>
                    <?merge archive.lastDeliveryDate.bool() ?>
                    <tr>
                        <th title="Last delivery date">Last delivery date</th>
                        <td id="lastDeliveryDate" title="[?merge archive.lastDeliveryDate ?]"><?merge archive.lastDeliveryDate ?></td>
                    </tr>
                    <?merge archive.lastModificationDate.bool() ?>
                    <tr>
                        <th title="Last modification date">Last modification date</th>
                        <td id="lastModificationDate" title="[?merge archive.lastModificationDate ?]"><?merge archive.lastModificationDate ?></td>
                    </tr>
                </table>
            </div>
            <button type="button" class="btn btn-default btn-sm pull-right" id="saveManagementMetadata" title="Save" style="border:0px solid transparent; display: none"><i class="fa fa-check" style="color: green"></i></button>
            <button type="button" class="btn btn-default btn-sm pull-right" id="cancelManagementEdition" title="Cancel" style="border:0px solid transparent; display: none" ><i class="fa fa-reply" style="color: red"></i></button>
            <!--<?merge archive.descriptionObject.bool() ?>
            <div class="panel">
                <div class="panel-heading text-center" role="tab">
                    <strong>
                        <a role="button" data-toggle="collapse" href="#metadata" >
                            <span class="text-info">Metadata</span>
                        </a>
                        <button type="button" class="btn btn-default btn-sm editMetadata" id="editMetadata" title="Update metadata" style="border:0px solid transparent"><i class="fa fa-edit"></i></button>
                        <button type="button" class="btn btn-default btn-sm saveMetadata" id="saveMetadata" title="Valid" style="border:0px solid transparent; display: none"><i class="fa fa-check" style="color: green"></i></button>
                        <button type="button" class="btn btn-default btn-sm cancelMetadataEdition" id="cancelMetadataEdition" title="Cancel" style="border:0px solid transparent; display: none" ><i class="fa fa-reply" style="color: red"></i></button>
                    </strong>
                </div>
                <div id="metadata" class="panel-collapse collapse" role="tabpanel">
                </div>
            </div>-->
        </div>
    </div>
</div>

<div class="hide">
    <div class="form-group" id="inputFinalDisposition">
        <br>
        <input type="radio" name="finalDisposition" class="input-sm" value="destruction">&nbsp;Destruction
        <input type="radio" name="finalDisposition" class="input-sm" value="preservation">&nbsp;Preservation
    </div>
    <!--div id="archiveName" data->
        <b>Archive name</b>
        <input id="inputArchiveName" type="text" class="form-control input-sm"/>
    </div-->
    <input id="inputArchiveName" name="archiveName" type="text" class="col-xs-12"/>
    <input id="inputOriginatorArchiveId" name="originatorArchiveId" type="text" class="col-xs-12"/>
    <input id="inputOriginatingDate" name="originatingDate" type="text" class="col-xs-12 datePicker"/>

    <input id="inputCustomNumericField" placeholder="Value" type="number" class="col-xs-12"/>

    <div  id="inputCustomBooleanField" class="btn-group" data-toggle="buttons">
        <label class="btn btn-xs btn-default">
            <input type="radio" name="defaultValue" autocomplete="off" value="0"><i class="fa fa-times"></i>
        </label>
        <label class="btn btn-xs btn-default active">
            <input type="radio" name="defaultValue" autocomplete="off" value="" checked>&nbsp;
        </label>
        <label class="btn btn-xs btn-default">
            <input type="radio" name="defaultValue" autocomplete="off" value="1"><i class="fa fa-check"></i>
        </label>
    </div>

    <input id="inputCustomBooleanField" placeholder="Value" type="text" class="col-xs-12"/>

    <input id="inputCustomField" placeholder="Value" type="text" class="col-xs-12"/>
    <input id="inputCustomLabel" placeholder="Label" type="text" class="col-xs-12" style="text-align: right"/>
    <span id="customFieldError_txt">Metadatas are incomplete.</span>
</div>

<style type="text/css">
    #archiveInformation {
        font-size: 12px;
        padding-top: 50px;
        min-height: calc(95vh - 80px) ;
    }
    #archiveInformation table {
        table-layout:fixed;
        width:100%;
    }
    #archiveInformation table th {
        width: 40%;
        text-align: right;
    }
    #archiveInformation table td, #archiveInformation table th {
        padding: 0 5px 0 5px ;
        text-overflow: crop;
        overflow: hidden;
        white-space: nowrap;

    }
    #archiveInformation .infoIcon {
        font-size: 80px; 
        margin-bottom: 10px;
    }
</style>

<script src="/public/js/bootstrap-toggle/bootstrap-toggle.js"></script>
<script>
    var ArchiveInformation = {
        archiveId: $('#archiveInformation').find('.archiveInformationId').val(),

        freeze: function() {
            var parameters = {
                archiveIds : ArchiveInformation.archiveId
            };
            
            $.ajax({
                type        : 'PUT',
                url         : "/recordsManagement/archive/freeze",
                data        : JSON.stringify(parameters),
                contentType : 'application/json',
                dataType    : 'json',
                success     : function (response) {
                    gritter.show(response.message, response.status, response.errors);

                    if (response.status) {
                        Archive.getInfo(ArchiveInformation.archiveId);
                    }
                },
                error       : function (response) {
                    gritter.show(response.responseJSON.message, response.responseJSON.status, response.responseJSON.errors);
                }
            });
        },

        unfreeze: function() {
            var parameters = {
                archiveIds : ArchiveInformation.archiveId
            };
            
            $.ajax({
                type        : 'PUT',
                url         : "/recordsManagement/archive/unfreeze",
                data        : JSON.stringify(parameters),
                contentType : 'application/json',
                dataType    : 'json',
                success     : function (response) {
                    gritter.show(response.message, response.status, response.errors);

                    if (response.status) {
                        Archive.getInfo(ArchiveInformation.archiveId);
                    }
                },
                error       : function (response) {
                    gritter.show(response.responseJSON.message, response.responseJSON.status, response.responseJSON.errors);
                }
            });
        },

        editManagementMetadata: function() {
            $('#editManagementMetadata').prop('disabled',true);
            $('#saveManagementMetadata').show();
            $('#cancelManagementEdition').show();

            if(!$('#managementInfo').hasClass('in')) {
                $('#managementInfo').addClass('in');
            }
            
            $('#retentionRuleSelect').show();
            $('#startDate').show();
            
            $("#retentionRuleCode").val($('#inputRetentionRuleCode').val());
            
            $('#finalDisposition').hide();
            $('#disposalDate').hide();
        },

        saveManagementMetadata: function() {
            var startDate = $('#archiveInformation').find('.startDate').val();
            
            var retentionRule = {
                retentionStartDate : startDate,
                retentionDuration : $('#retentionRuleCode option:selected').data('duration'),
                finalDisposition : $('#retentionRuleCode option:selected').data('finaldisposition')
            };
            
            var parameters = {
                retentionRule : retentionRule,
                archiveIds: ArchiveInformation.archiveId
            };
            
            $.ajax({
                type        : 'PUT',
                url         : "/recordsmanagement/archive/retentionrule",
                data        : JSON.stringify(parameters),
                contentType : 'application/json',
                dataType    : 'json',
                success     : function (response) {
                    gritter.show(response.message, response.status, response.errors);

                    if (response.status) {
                        Archive.getInfo(ArchiveInformation.archiveId);
                    }
                },
                error       : function (response) {
                    gritter.show(response.responseJSON.message, response.responseJSON.status, response.responseJSON.errors);
                }
            });
        },

        cancelMetadataEdition: function() {
            Archive.getInfo(ArchiveInformation.archiveId);
            $('#archiveCustomFieldAddBtn').hide();
        },

        editMetadata: function() {
            var archiveInformation=$('#archiveInformation');
            $('#editMetadata').prop('disabled',true);
            $('#saveMetadata').show();
            $('#cancelMetadataEdition').show();
            $('#archiveCustomFieldAddBtn').show();
            //$('#archiveInformation').find('.originatorArchiveId').hide();
            //$('#archiveInformation').find('.archiveName').hide();
            
            archiveInformation.find('.archiveName')
                              .children('td')
                              .html('')
                              .append($('#inputArchiveName').val($('#archiveInformation').find('.archiveName').val()));
            
            archiveInformation.find('.originatorArchiveId')
                              .children('td')
                              .html('')
                              .append($('#inputOriginatorArchiveId').val($('#archiveInformation').find('.originatorArchiveId').val()));

            archiveInformation.find('.originatingDate')
                              .children('td')
                              .html('')
                              .append($('#inputOriginatingDate').datepicker('setDate', $('#archiveInformation').find('.originatingDate').val()));

            $('#metadata').find('tr').each(function(i, e) {
                var label = $(e).children('th');
                var value = $(e).children('td');
                var customField = null;

                var customLabel = $("#inputCustomLabel").clone();
                customLabel.removeAttr('id').val(label.html()).attr('name', label.attr('name'));
                label.html('').append(customLabel);
                var booleanInput = null;

                switch(label.data('type')) {
                    case 'boolean' :
                        customField = $("#inputCustomBooleanField").clone();
                        if(label.data('immutable')) {
                            customField.prop('disabled', true);
                        }
                        var intValue = value.find('i').data('value');
                        booleanInput = customField.find('input[value="'+intValue+'"]');
                        break;
                    case 'number':
                        customField = $("#inputCustomNumericField").clone();
                        if(label.data('immutable')) {
                            customField.prop('disabled', true);
                        }
                        customField.val(value.html());
                        break;
                    case 'date':
                        customField = $("#inputCustomField").clone();
                        customField.datepicker(DatePickerParams).datepicker('setDate', value.html());
                        if(label.data('immutable')) {
                            customField.prop('disabled', true);
                        }
                        customField.datepicker({
                            language:$('#wrapper').attr('lang'),
                            autoclose:true
                        }).datepicker('setDate', value.html());
                        break;
                    default :
                        customField = $("#inputCustomField").clone();
                        if(label.data('immutable')) {
                            customField.prop('disabled', true);
                        }
                        customField.val(value.html());
                }
                
                value.html('').append(customField.removeAttr('id'));

                if (booleanInput && booleanInput.length) {
                    booleanInput.click();
                }
            });


            $('#metadata').find('.archivalProfileField').find('th input').prop('disabled', true);
        },

        saveMetadata: function() {
            var descriptionFields = {};
            $('#metadata').find('tr').each(function(i, e) {
                var input = $(e).find('th > input');
                var valueInput = $(e).find('td > input');
                var label = input.val();
                var name = input.attr('name');
                var type = $(e).find('th').data('type');
                var value = null;

                switch (type) {
                    case "name" :
                    case "text" :
                        value = valueInput.val();
                        break;
                    case "date" :
                        value = valueInput.data('datepicker').getFormattedDate('yyyy-mm-dd');
                        break;
                    case "number" :
                        value = parseInt(valueInput.val());
                        break;
                    case "boolean" :
                        var inputValue = valueInput.parent('.active').find('input').val();
                        value = inputValue == 1 ? true : false;
                        break;
                    default:
                }

                if ($(e).hasClass('archivalProfileField')) {
                    descriptionFields[name] = value;
                } else if (label != '' && value != '') {
                    descriptionFields[label] = value;
                } else if (label == '' && value != '') {
                    gritter.show($('#customFieldError_txt').text(), false);
                    descriptionFields = false;
                    return;
                }
            });

            var parameters = {
                archiveId           : ArchiveInformation.archiveId,
                originatorArchiveId : $('#inputOriginatorArchiveId').val(),
                archiveName         : $('#inputArchiveName').val(),
                originatingDate     : $('#inputOriginatingDate').data('datepicker').getFormattedDate('yyyy-mm-dd'), 
                description         : descriptionFields
            };

            $.ajax({
                type        : 'PUT',
                url         : "/recordsmanagement/archive/metadata",
                data        : JSON.stringify(parameters),
                contentType : 'application/json',
                dataType    : 'json',
                success     : function (response) {
                    gritter.show(response.message, response.status, response.errors);

                    if (response.status) {
                        Archive.getInfo(ArchiveInformation.archiveId);
                    }
                },
                error       : function (response) {
                    gritter.show(response.responseJSON.message, response.responseJSON.status, response.responseJSON.errors);
                }
            });

            $('#archiveCustomFieldAddBtn').hide();
        },

        addField : function(type) {
            var label = $('#inputCustomLabel').clone().val('').prop('disabled', false);
            var value = $('#inputCustomField').clone().val('');

            if(type == 'date') {
                value.datepicker({
                    language:$('#wrapper').attr('lang'),
                    autoclose:true
                });
            }

            var tr = $('<tr/>').append($('<th/>').data("type", type).append(label))
                               .append($('<td/>').append(value));

            $('#metadata').children('table').append(tr);
        },

        loadImportForm: function(e) {
            var importPanel = $("#importPanel");
            var archiveInformation = $('#archiveInformation');

            var parentArchiveId = archiveInformation.find(".archiveInformationId").val();
            var parentArchiveName = $('#archiveInformation').find('.archiveName').val();

            $("#archiveForm [name='archivalProfileReference']").val(e.data("reference")).data("json", e.data("json")).change();

            importPanel.find("[data-context-path]:first").text($("#folderPath").text());
            importPanel.find("[data-context-description]:first").text($("#folderDescription").text());
            importPanel.find("[data-context-profil]:first").text(e.text());

            $("#archiveForm [name='parentArchiveId']").val(parentArchiveId);
            importPanel.find("[data-context-parentarchive]")
                       .removeClass('hide')
                       .find('[data-context-parentname]').text(parentArchiveName);

            $('#importTab').click();
            $('#rightColumn').empty();
        }
    }
    
    $('#archiveInformation').on('click','.freeze', function(){
        ArchiveInformation.freeze();
    });
    
    $('#archiveInformation').on('click','.unfreeze', function(){
        ArchiveInformation.unfreeze();
    });
    
    $('#editManagementMetadata').on('click', function(){
         ArchiveInformation.editManagementMetadata();
    });
    
    $('#cancelManagementEdition, #cancelMetadataEdition').on('click', function(){
         ArchiveInformation.cancelMetadataEdition();
    });
    
    $('#saveManagementMetadata').on('click', function(){
         ArchiveInformation.saveManagementMetadata();
    });
    
    $('#editMetadata').on('click', function(){
        ArchiveInformation.editMetadata();
    });
    
    $('#archiveInformation').on('click','.addCustomField',function(){
       ArchiveInformation.addField($(this).data('type'));
    });
    
    $('#saveMetadata').on('click', function(){
        ArchiveInformation.saveMetadata();
    });

    $("#archiveToolbarBtn").on('click', '.newArchive', function() {
        ArchiveInformation.loadImportForm($(this));
    });
        
</script>
