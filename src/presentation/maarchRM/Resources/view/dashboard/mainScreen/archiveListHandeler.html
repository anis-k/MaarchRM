<div id="archiveContentTemplate" class="hide">
    <li>
        <span>
            <span class="archive-bg">
                <i class='fa'/>
                <span name="archiveOrDocument">&nbsp;</span>
                <div class="dropdown pull-right addChildrenArchive addingNew hide childrenArchiveSelector">
                    <button class="btn btn-xs btn-default" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                        <span class="fa fa-plus"></span>
                    </button>
                    <ul class="dropdown-menu">
                    </ul>
                </div>
                <br/>
                &nbsp;&nbsp;&nbsp;&nbsp;
                <small/>&nbsp;
                <small/>&nbsp;
                <small>
                    <i/>
                </small>
            </span>
        </span>
    </li>
</div>

<span data-translate-catalog="recordsManagement/archivalProfile" class="hide" id="withoutProfile_txt">Without profile</span>

<style>
    .archive h5 {
        margin: 5px 0px 5px 0px;
        width: 100%;
        white-space: nowrap;
        text-overflow: crop;
        position: inherit;
    }
    .archive small {
        font-size: 10px;
        color: darkgrey;
    }
    .archiveInfo {
        width: calc(100% - 25px);
        margin-left: 10px;
    }
    .archive .tree-l {
        font-size: 12px;
        margin: 0px;
    }
    .archive .tree-l li, .archive .tree-l li>span>span {
        padding: 0px;
        text-overflow: crop;
        width: 100%;
    }
    .tree-l .parent_li{
        position: inherit ;
    }
    .archiveInfo :hover, .archive .tree-l li>span:hover {
        background-color: #DDD;
    }
    .dataList {
        min-height: 300px;
    }
    .dataList .archiveContentButton,
    .dataList .archiveInfo,
    .dataList .bg-success,
    .dataList .archive .tree-l li>span {
        cursor: pointer;
    }
    .dataList .selectedChild, .selected .archiveName{
        font-weight: bold;
    }
    .dataList .fa-caret-right, .dataList .fa-caret-down {
        font-size: 16px;
    }
    .archive .archiveContent li>span {
        width: 100%;
        white-space: nowrap;
        text-overflow: crop;
        line-height: normal;
        padding: 0px 0px;
    }
    .childrenArchive {
        padding: 0px 8px !important;
    }
    .archive  > h5 {
        margin: 0px;
    }
    .archive > h4 {
        margin-top: 3px;
    }
    .addChildrenArchive {
        position: absolute;
        right: 10px;
        z-index: 8;
        margin-top: 10px;
    }
    .childrenArchiveSelector {
        z-index: 8;
        padding-top: 0px;
        right: 5px ;
        position: relative;
        bottom: 4px;
    }
    .childrenArchiveSelector > .btn > .fa-plus {
        padding : 0px 0px ;
    }

    .addingNew > .dropdown-menu {
        min-width: 180px;
    }

    .addingNew > .dropdown-menu > li > span {
        white-space: nowrap;
        padding : 0px 10px ;
    }

    .newResource {
        cursor: pointer;
    }

</style>

<script type="text/javascript">
	var Archive = {
        archiveContentTemplate: $('#archiveContentTemplate').children('li'),

        selected: null,

        select: function(e, c) {
            this.unselect(e.closest('.dataList'));
            if (!c) {
                this.selected = e;
                e.find('.archiveInfo:first').addClass('selected');
                this.selected.children('.selected').children("h5").addClass('bg-info') ;
            } else {
                this.selected = c.closest('li');
                this.selected.addClass('parent_li') ;
                c.addClass('selectedChild');
                this.selected.children('span').children('.archive-bg').addClass('bg-info') ;
            }
        },

        unselect: function(dataList) {
            var multipleSelection = dataList.find('.selectAll.multipleSelection');
            if (multipleSelection.hasClass('fa-check-square-o')) {
                multipleSelection.click();
            }
            dataList.find('.bg-info').removeClass('bg-info') ;
            dataList.find('.multipleSelection.fa-check-square-o').click();
            dataList.find('.selectedChild, .archiveInfo').removeClass('selected selectedChild');
            dataList.find('.addingNew').addClass('hide');
            this.selected = null;
        },

        remove: function(archivesIds) {
            $('#'+archivesIds.join(', #')).removeFromDataList();
        },

        getInfo: function(archiveId) {
            $.ajax({
                url         : "/archive/"+archiveId,
                type        : "GET",
                success     : function (response) {
                    trigger("showArchiveDetails.recordsManagement", [response, "/archive/"+archiveId]);
                    var div = $(response).find('>div');
                    if(Archive.checkRights(div.data('children-archive-profiles'), div.data('accept-without-profile'), div.data('fileplan-level'))) {
                        Archive.loadChildrenArchiveButton(div.data('children-archive-profiles'), div.data('accept-without-profile'), div.data('fileplan-level'));
                    }
                },
                error       : function (response) {
                    gritter.show(response.responseText, false);
                }
            })
        },

        getContent: function(archive) {
            $.ajax({
                url         : "/archiveContents/"+archive.attr('id'),
                type        : "GET",
                dataType    : 'json',
                success     : function (response) {
                    archive.find('.archiveContent').removeClass('hide').find('ul').html('');
                    Archive.showArchiveContent(archive.find('.archiveContent'), response.digitalResources, response.contents, false);
                },
                error       : function (response) {
                    gritter.show(response.responseText, false);
                }
            })
        },

        getResourceInfo: function(resource) {
            $.ajax({
                url         : "/documentInfo",
                type        : "GET",
                success     : function (response) {
                    trigger("showDocumentDetails.recordsManagement", [response, resource.data('json')]);
                },
                error       : function (response) {
                    gritter.show(response.responseText, false);
                }
            })
        },

        showArchiveContent: function(parent, digitalResources, childrenArchives, hidden) {
            var count=100
            if (childrenArchives) {
                for(var j=0; j < childrenArchives.length && count>0; j++) {
                    count--;
                    template = this.archiveContentTemplate.clone();
                    var smalls = template.find('small');

                    if (childrenArchives[j].fileplanLevel == 'item') {
                        var icon = $('<i class="fa fa-file">&nbsp;</i>');
                    } else {
                        var icon = $('<i class="fa fa-archive">&nbsp;</i>');
                    }

                    template.children('span')
                            .addClass('childrenArchiveSelection')
                            .children('span')
                            .children('i')
                            .addClass('fa')
                            .data('closed-icon', 'fa-caret-right')
                            .data('opened-icon', 'fa-caret-down')
                            .siblings('span')
                            .addClass('archive childrenArchive')
                            .attr('id', childrenArchives[j].archiveId)
                            .append(icon)
                            .append($('<span>').text(childrenArchives[j].archiveName))
                            .append($('<a/>').attr('href','#').class);

                    if (childrenArchives[j].archivalProfileName) {
                        $(smalls[0]).text(childrenArchives[j].archivalProfileName);
                    }

                    if (childrenArchives[j].originatorArchiveId) {
                        $(smalls[1]).text(' ' + childrenArchives[j].originatorArchiveId);
                    }

                    if (childrenArchives[j].originatingDate) {
                        $(smalls[2]).text(' ' + childrenArchives[j].originatingDate);
                    }

                    BootstrapTree.addNode(parent, template, hidden);

                    var children = null;
                    if (childrenArchives[j].contents) {
                        children = childrenArchives[j].contents;
                    }

                    Archive.showArchiveContent(template, childrenArchives[j].digitalResources, childrenArchives[j].contents, false);
                }
            }

            if (digitalResources) {
                for(var i=0; i < digitalResources.length; i++) {
                    template = this.archiveContentTemplate.clone();
                    template.children('span')
                            .addClass('document')
                            .data('json', digitalResources[i])
                            .children('span')
                            .children('i')
                            .html('&nbsp;&nbsp;')
                            .siblings('span')
                            .attr('id', digitalResources[i].resId)
                            .append($('<i class="fa fa-file-o">&nbsp;</i>'))
                            .append($('<span>').text(digitalResources[i].fileName));
                    template.find('small, br, .addChildrenArchive').remove();

                    BootstrapTree.addNode(parent, template, hidden);
                }
            }
        },

        checkRights: function (archivalProfiles, withoutProfile, fileplanLevel){
          var button = this.selected.closest('.archive').find('.addChildrenArchive');
          var archiveStatus = button.closest('.archive').find('.status').text();
          if (archiveStatus == 'disposed' || fileplanLevel == 'item' || (!archivalProfiles.length && withoutProfile !== 1)) {
              return false;
          }
          return true
        },

        loadChildrenArchiveButton: function(archivalProfiles, withoutProfile) {
            var button = this.selected.find('.addingNew');
            var list =  button.find('ul');

            if (Archive.selected.find(".selectedChild").attr("id")) {
                var archiveId = Archive.selected.find(".selectedChild").attr("id");
                Archive.selected.find(".selectedChild").siblings('.addingNew').removeClass("hide");
            } else {
                var archiveId = button.closest('.archive').attr('id');
                button.closest('.archive').children('.addingNew').removeClass("hide");
            }

            var archiveName = button.closest('.archive').find('.archiveName').text();

            list.empty();

            // Add children archive : 
            list.append(
                $('<li/>').html(
                    $('<span/>').addClass('newResource')
                                .data('parent-archive-id', archiveId)
                                .data('parent-archive-name', archiveName)
                                .text($('#archiveResource').text())
                )
            );

            list.append(
                $('<li/>').html(
                    $('<span/>').addClass('titleNewArchive')
                                .text($('#archiveProfiles').text())
                )
            );

            if (withoutProfile == 1) {
                list.append(
                    $('<li/>').html(
                        $('<a/>').attr('href', '#')
                                 .addClass('small newArchive')
                                 .data('parent-archive-id', archiveId)
                                 .data('parent-archive-name', archiveName)
                                 .text($('#withoutProfile_txt').text())
                    )
                );
            }

            $.each(archivalProfiles, function() {
                list.append(
                    $('<li/>').html(
                        $('<a/>').attr('href', '#')
                                 .addClass('small newArchive')
                                 .data('json', JSON.parse(this.json))
                                 .data('parent-archive-id', archiveId)
                                 .data('parent-archive-name', archiveName)
                                 .text(this.name)
                    )
                );
            })
            
            var position = this.selected.position();
        }
    }

    // List icon toggle
    $('#middleColumn').on('click', '.archiveContentButton', function() {
        var caret = $(this);
        if (caret.hasClass('fa-caret-right')) {
            caret.removeClass('fa-caret-right')
            	 .addClass('fa-caret-down')
            	 .closest('.dataList')
            	 .find('.fa-caret-down')
                 .not(caret)
            	 .click();
            Archive.getContent(caret.closest('.archive'));
        } else {
            caret.removeClass('fa-caret-down').addClass('fa-caret-right')
                 .closest('div').siblings('.archiveContent').addClass('hide');
        }
    })

    // Actions on archives
    $('#middleColumn').on('click', '.archiveInfo ', function() {
        var archive = $(this).closest('.archive');
        var archiveId = archive.attr('id');
        Archive.select(archive);
        Archive.getInfo(archiveId);
    })

    $('#middleColumn').on('click', '.dataList', function(e) {
        if ($(e.target).css('cursor') != "pointer") {
            Archive.unselect($(this).closest('.dataList'));
            trigger("unselectArchive.recordsManagement");
        }
    })

    $('#middleColumn').on('click', '.childrenArchiveSelection', function() {
    	var child = $(this).find('.childrenArchive:first');
        var parentArchive = child.closest('.archive');
        var archiveId = child.attr('id');
        Archive.select(parentArchive, child);
        Archive.getInfo(archiveId);
    })

    $('#middleColumn').on('click', '.document', function() {
    	var doc = $(this);
        var parentArchive = doc.closest('.archive');
        Archive.select(parentArchive, doc);
        Archive.getResourceInfo(doc);
    })

    $('#middleColumn').on('datalist.pagechanging', function(e) {
        $(e.target).find('.fa-caret-down').click();

    })

    $('#middleColumn').onEvent('showDetails.archive', function(e, archiveId) {
         Archive.getInfo(archiveId);
    })

</script>
