<div class="tab-pane fade in active col-xs-12" id="folderPanel">
    <div class="row">
        <h4 class="pull-left">
            <span id="folderPath"/>
            <br/>
            <small id="folderDescription"/>
        </h4>
    </div>
    <div id="folderContentList">
        <div class="row hide">
            <div id="folderToolbarBtn" class="dropdown pull-right btn-group">
                <button type="button" class="btn btn-sm btn-default" id="folderToolbarSearch" title="Search" disabled><span class="fa fa-search"></span></button>
                <button type="button" class="btn btn-sm btn-default dropdown-toggle" id="folderToolbarImport" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true" title="Create" disabled><span class="fa fa-plus"></span></button>
                <ul class="dropdown-menu" aria-labelledby="dropdownMenu1">
                    <li><a class="small" style="cursor: pointer;" data-reference="">New archive</a></li>
                </ul>
            </div>
        </div>
    </div>
</div>

<div id="listTemplate" class="hide">
    <div class="archive row">
        <div class="col-xs-11">
            <h5>
                <i class="archiveContentButton fa fa-caret-right">&nbsp;</i>
                <a href="#" class="archiveName"></a>
                <br/>
                &nbsp;&nbsp;
                <small/>&nbsp;
                <small/>&nbsp;
                <small><i/></small>
            </h5>
        </div>
        <div class="archiveContent col-xs-12 hide">
            <ul class="tree-l">
            </ul>
        </div>
    </div>
</div>
<div id="archiveContentTemplate" class="hide">
    <li>
        <span>
            <i class='fa'/>
            <span></span>
        </span>
    </li>
</div>

<div class="hide">
    <span id="archives_text">archives</span>
    <span id="emptyFolder_text">Empty folder</span>
    <span id="archiveName_text">Name</span>
    <span id="depositDate_text">Deposit date</span>
</div>
<style>
    .archive h5 {
        margin: 6px 0px 6px 0px;
    }
    .archive small {
        font-size: 10px;
    }
    .archive .tree-l {
        font-size: 12px;
        margin: 0px;
    }
    .archive .tree-l li, .archive .tree-l li>span>span {
        padding: 0px;
    }

    .dataList .archiveContentButton
    .dataList a,
    .dataList .bg-success,
    .dataList .archive .tree-l li>span>span {
        cursor: pointer;
    }
    .dataList .selectedChild {
        font-weight: bold;
    }

</style>

<script type="text/javascript">
    ArchiveList = {
        rowTemplate: $('#listTemplate > .archive'),
        folderContents: $('#folderContentList'),

        select: function(e, c) {
            this.unselect();
            e.addClass('bg-success');

            if (c) { c.addClass('selectedChild') }
         },

        unselect: function() {
            $('#rightColumn').html('');
            this.folderContents.find('.bg-success').removeClass('bg-success')
                               .find('.selectedChild').removeClass('selectedChild');
        },

        getfolderContents: function(orgRegNumber, folderId, path, description, archivalProfiles) {
            var url = "/folder?orgRegNumber="+orgRegNumber;
            if (folderId) {
                url = url + "&folderId="+folderId;
            }

            $.ajax({
                url         : url,
                type        : "GET",
                dataType    : 'json',
                success     : function (response) {
                    ArchiveList.buildResultList(response.archives);
                    $('#folderPath').text(path);
                    $('#folderDescription').html(description);
                },
                error       : function (response) {
                    gritter.show(response.responseText, false);
                }
            })

            this.getImportForm(orgRegNumber, folderId, archivalProfiles);
            $("#folderToolbarSearch").data("orgregnumber", orgRegNumber).data("folderid", folderId);
        },

        buildResultList: function(archives) {
            $('#rightColumn').html('');

            if (archives.length) {
                $('#folderToolbarFreeze').removeAttr("disabled");
                $('#folderToolbarUnfreeze').removeAttr("disabled");
                $('#folderToolbarSearch').removeAttr("disabled");
            } else {
                $('#folderToolbarFreeze').attr("disabled", "disabled");
                $('#folderToolbarUnfreeze').attr("disabled", "disabled");
                $('#folderToolbarSearch').attr("disabled", "disabled");
            }

            $('#folderContentList').dataList({
                datas        : archives,
                rowMerge     : ArchiveList.mergeRow,
                rowMaxNumber : 10,
                emptyMessage : '<i class="text-muted"><br\/><span class="fa fa-times">&nbsp;<\/span>'+$('#emptyFolder_text').html()+'<\/i>',
                sorting: [
                    {
                        fieldName : 'archiveName',
                        label     : $('#archiveName_text').text()
                    },
                    {
                        fieldName : 'depositDate',
                        label     : $('#depositDate_text').text()
                    }
                ]
            })

            this.initDragNDrop();
        },

        mergeRow: function(archive) {
            var archiveDiv = ArchiveList.rowTemplate.clone();
            var siblings = archiveDiv.attr('id', archive.archiveId)
                                     .find('.archiveName').text(archive.archiveName)
                                     .siblings('small');

            if (archive.depositDate) {
                $(siblings[0]).text(archive.depositDate.substring(0, 19));
            }
            if (archive.archivalProfileReference) {
                $(siblings[1]).text(archive.archivalProfileReference);
            }
            if (archive.originatorArchiveId) {
                $(siblings[2]).children('i').text(archive.originatorArchiveId);
            }

            return archiveDiv;
        },

        initDragNDrop: function() {
            $('#folderContentList').find('.archive').draggable({
                revert : true,
                zIndex: 100,
                delay: 200,
                helper: function() {
                    var archive = $(this);
                    var archiveIds = [];
                    var helper = $('<div/>');
                    var title = ""

                    if (archive.hasClass('bg-info')) {
                        $('#folderContentList').find('.bg-info').each(function() {
                            archiveIds.push($(this).attr('id'));
                            title = archiveIds.length + ' ' + $('#archives_text').text();
                        })
                    } else {
                            archiveIds.push(archive.attr('id'));
                            title = archive.find('.archiveName').html();
                    }

                    helper.addClass('archiveHelper')
                        .data('archives', archiveIds)
                        .append($('<i/>').addClass("fa fa-archive")
                                         .css('text-align', 'center')
                                         .css('font-size', '40px'))
                        .append('<br/>')
                        .append(title)
                        .css('opacity', '0.8')
                        .css('color', 'grey')
                        .css('text-align', 'center');
                    return helper
                },
            cancel: ".fa"
            })
        },

        removeArchives: function(archivesIds) {
            $('#'+archivesIds.join(', #')).removeFromDataList();
        },
        
        getImportForm: function(orgRegNumber, folderId, archivalProfiles) {
            if (archivalProfiles.length < 1) {
                $('#folderToolbarImport').attr("disabled", "disabled");
                $('#folderTab').click();
                return;
            }
            
            $("#folderToolbarBtn .dropdown-menu").data("archivalprofiles", JSON.stringify(archivalProfiles));

            $('#folderToolbarImport').removeAttr("disabled");
            $('#archiveForm [name="filePlanPosition"]').val(folderId);
            $('#archiveForm [name="originatorOrgRegNumber"]').val(orgRegNumber);
        },

        refresh: function() {
            FilePlan.selectedNode.find('b:first').click();
        }
    }

    Archive = {
        archiveContentTemplate: $('#archiveContentTemplate').children('li'),

        getInfo: function(archiveId) {
            $.ajax({
                url         : "/archive/"+archiveId,
                type        : "GET",
                success     : function (response) {
                    $('#rightColumn').html(response);
                },
                error       : function (response) {
                    gritter.show(response.responseText, false);
                }
            })
        },

        getContent: function(archive) {
            $.ajax({
                url         : "/archiveContents/"+archive.attr('id'),
                type        : "GET",
                dataType    : 'json',
                success     : function (response) {
                    archive.find('.archiveContent').removeClass('hide').find('ul').html('');
                    Archive.showArchiveContent(archive.find('.archiveContent'), response.digitalResources, response.childrenArchives, false);
                },
                error       : function (response) {
                    gritter.show(response.responseText, false);
                }
            })
        },

        getResourceInfo: function(resource) {
            $.ajax({
                url         : "/documentInfo",
                type        : "GET",
                success     : function (response) {
                    $('#rightColumn').html(response);
                    DocumentInformation.load(resource.data('json'));
                },
                error       : function (response) {
                    gritter.show(response.responseText, false);
                }
            })
        },

        showArchiveContent: function(parent, digitalResources, childrenArchives, hidden) {
            var count=100
            if (childrenArchives) {
                for(var j=0; j < childrenArchives.length && count>0; j++) {
                    count--;
                    template = this.archiveContentTemplate.clone();

                    template.children('span')
                            .children('i')
                            .addClass('fa')
                            .data('closed-icon', 'fa-caret-right')
                            .data('opened-icon', 'fa-caret-down')
                            .siblings('span')
                            .addClass('childrenArchive')
                            .attr('id', childrenArchives[j].archiveId)
                            .html(childrenArchives[j].archiveName);

                    BootstrapTree.addNode(parent, template, hidden);

                    var children = null;
                    if (childrenArchives[j].childrenArchives) {
                        children = childrenArchives[j].childrenArchives;
                    }

                    Archive.showArchiveContent(template, childrenArchives[j].digitalResources, childrenArchives[j].childrenArchives, false);
                }
            }

            if (digitalResources) {
                for(var i=0; i < digitalResources.length; i++) {
                    template = this.archiveContentTemplate.clone();

                    template.children('span')
                            .children('i')
                            .addClass('fa fa-file-o')
                            .siblings('span')
                            .addClass('document')
                            .data('json', digitalResources[i])
                            .attr('id', digitalResources[i].resId)
                            .html(digitalResources[i].fileName);

                    BootstrapTree.addNode(parent, template, hidden);
                }
            }
        }
    }

    function buildDropdownMenu() {
        var archivalProfiles = JSON.parse($("#folderToolbarBtn .dropdown-menu").data("archivalprofiles"));
        var dropdownAction = $("#folderToolbarBtn .dropdown-menuAction");
        
        dropdownAction.append()
        var dropdown = $("#folderToolbarBtn .dropdown-menu");
        dropdown.children().not(":first").remove();

        for (var i = 0; i < archivalProfiles.length; i++) {
            var a = $("<a/>")
                    .addClass("userProfile small")
                    .data("reference", archivalProfiles[i].reference)
                    .data("json", JSON.stringify(archivalProfiles[i]))
                    .attr('style', "cursor: pointer;")
                    .text(archivalProfiles[i].name);
            $("<li/>").append(a).appendTo(dropdown);
        }
        
        if ($("#folderContentList").find(".bg-success").length < 1) {
            return;
        }

        /*var childrenOrg = [];

        FilePlan.getChildrenOrg().each(function() {
            childrenOrg.push({
                    name             : $(this).find("b:first").text(),
                    orgRegNumber     : $(this).data('orgregnumber'),
                    archivalProfiles : $(this).data('archivalprofiles')
                }
            );
        })

        var divider = $("<li/>").addClass("divider");
        var separator = $("<li/>").addClass("small dropdown-header");

        for (var i = 0; i < childrenOrg.length; i++) {
            if (childrenOrg[i].archivalProfiles.length < 1) {
                continue;
            }

            divider.clone().appendTo(dropdown);
            separator.clone().text(childrenOrg[i].name).appendTo(dropdown);
            
            for (var j = 0; j < childrenOrg[i].archivalProfiles.length; j++) {
                var a = $("<a/>")
                        .addClass('childrenProfile small')
                        .data("orgregnumber", childrenOrg[i].orgRegNumber)
                        .data("reference", childrenOrg[i].archivalProfiles[j].reference)
                        .data("json", JSON.stringify(childrenOrg[i].archivalProfiles[j]))
                        .text(childrenOrg[i].archivalProfiles[j].name);
                $("<li/>").append(a).appendTo(dropdown);
            }
        }*/
    }

    // List icon toggle
    $('#folderContentList').on('click', '.archiveContentButton', function() {
        var caret = $(this);
        if (caret.hasClass('fa-caret-right')) {
            $('#folderContentList').find('.fa-caret-down').click();
            caret.removeClass('fa-caret-right').addClass('fa-caret-down');
            Archive.getContent($(this).closest('.archive'));
        } else {
            caret.removeClass('fa-caret-down').addClass('fa-caret-right')
                 .closest('div').siblings('.archiveContent').addClass('hide');
        }
    })

    // Actions on archives
    $('#folderContentList').on('click', '.archiveName', function() {
        var archive = $(this).closest('.archive');
        var archiveId = archive.attr('id');
        ArchiveList.select(archive);
        Archive.getInfo(archiveId);
        archive.addClass('bg-success');
        console.log(archive);
    })

    $('#folderPanel').on('click', function(e) {
        if ($(e.target).css('cursor') != "pointer") {
            ArchiveList.unselect();
        }
    })


    $('#folderContentList').on('click', '.childrenArchive', function() {
        var parentArchive = $(this).closest('.archive');
        var archiveId = $(this).attr('id');
        ArchiveList.select(parentArchive, $(this));
        Archive.getInfo(archiveId);
    })

    $('#folderContentList').on('click', '.document', function() {
        var parentArchive = $(this).closest('.archive');
        ArchiveList.select(parentArchive, $(this));
        Archive.getResourceInfo($(this));
    })

    $("#folderToolbarBtn").on("show.bs.dropdown", function() {
        buildDropdownMenu();
    });

    $("#folderToolbarBtn").on('click', '.dropdown-menu li a', function() {
        /*if ($(this).hasClass("childrenProfile")) {
            $("#archiveForm [name='filePlanPosition']").val("");
            $("#archiveForm [name='originatorOrgRegNumber']").val($(this).data("orgregnumber"));
        }*/
        var parentArchiveId = $("#folderContentList").find(".bg-success").attr("id");
        $("#archiveForm [name='parentArchiveId']").val(parentArchiveId);
        $("#archiveForm [name='archivalProfileReference']").val($(this).data("reference")).data("json", $(this).data("json")).change();

        $("#importPanel").find("[data-context-path]:first").text($("#folderPath").text());
        $("#importPanel").find("[data-context-description]:first").text($("#folderDescription").text());
        $("#importPanel").find("[data-context-profil]:first").text($(this).text());

        $('#importTab').click();
    });

    $("#folderToolbarSearch").on('click', function() {
        searchTab.run($(this).data("orgregnumber"), $(this).data("folderid"));
    });
    
    $("#folderToolbarBtn").on('click','.freeze', function() {
        var archivesIds = [];
        $('#folderContentList').find('.fa-check-square-o').closest('div').each(function(i,ele){
            if (ele.attributes[1]) {
                archivesIds.push(ele.attributes[1].value);
            }
        });
        
        var parameters = {
            archiveIds : archivesIds
        };
        
        $.ajax({
            type        : 'PUT',
            url         : "/recordsManagement/archive/freeze",
            data        : JSON.stringify(parameters),
            contentType : 'application/json',
            dataType    : 'json',
            success     : function (response) {
                gritter.show(response.message, response.status, response.errors);
            },
            error       : function (response) {
                gritter.show(response.responseJSON.message, response.responseJSON.status, response.responseJSON.errors);
            }
        });
    });
    
    $("#folderToolbarBtn").on('click','.unfreeze', function() {
       var archivesIds = [];
        $('#folderContentList').find('.fa-check-square-o').closest('div').each(function(i,ele){
            if (ele.attributes[1]) {
                archivesIds.push(ele.attributes[1].value);
            }
        });
        
        var parameters = {
            archiveIds : archivesIds
        };
        
        $.ajax({
            type        : 'PUT',
            url         : "/recordsManagement/archive/unfreeze",
            data        : JSON.stringify(parameters),
            contentType : 'application/json',
            dataType    : 'json',
            success     : function (response) {
                gritter.show(response.message, response.status, response.errors);

            },
            error       : function (response) {
                gritter.show(response.responseJSON.message, response.responseJSON.status, response.responseJSON.errors);
            }
        });
    });
</script>
