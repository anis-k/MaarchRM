<div class="tab-pane fade in active col-xs-12" id="folderPanel">
    <div class="row">
        <h4 class="pull-left">
            <span id="folderPath"/>
            <br/>
            <small id="folderDescription"/>
        </h4>
        <a class="pull-right" id="importTabLink" data-toggle="tab" data-parentarchiveid="" style="display: none;cursor: pointer"><span class="fa fa-plus">&nbsp;</span>Create</a>
    </div>
    <i id="emptyFolderMessage" class="hide text-muted"><br/><span class="fa fa-times">&nbsp;</span>Empty folder</i>
    <div id="folderContentList" class="hide">
        <div class="row">
            <h4 class="pull-left" style="width:15px"><i class="selectAll archiveSelection fa fa-square-o"/></h4>
        </div>
        <div id="folderContents"/>
    </div>
</div>

<div id="listTemplate" class="hide">
    <div class="archive row">
        <h4 class="pull-left" style="width:15px"><i class="archiveSelection fa fa-square-o"/></h4>
        <div class="col-xs-11">
            <h5>
                <i class="archiveContentButton fa fa-caret-right">&nbsp;</i>
                <a href="#" class="archiveName"></a>
                &nbsp;<small><i/></small>
                <br/>
                <small/>&nbsp;
                <small/>
            </h5>
        </div>
        <div class="archiveContent col-xs-12 hide">
            <ul class="tree-l">
            </ul>
        </div>
    </div>
</div>
<div id="archiveContentTemplate" class="hide">
    <li>
        <span>
            <i class='fa'/>
            <span></span>
        </span>
    </li>
</div>
<style>
    .archive h5 {
        margin: 6px 0px 6px 0px;
    }
    .archive small {
        font-size: 10px;
    }
    .archive .tree-l {
        font-size: 12px;
        margin: 0px;
    }
    .archive .tree-l li, .archive .tree-l li>span>span {
        padding: 0px;
    }
    #folderContentList .archiveSelection, #folderContentList .archiveContentButton, .archive .tree-l li>span>span {
        cursor: pointer;
    }

</style>

<script type="text/javascript">
    ArchiveList = {
        archivesOrder: [],
        archivesList: [],
        folderContents: $('#folderContents'),

        select: function(e) {
            this.unselect()
            e.addClass('bg-success');
        },

        unselect: function() {
            $('#rightColumn').html('');
            this.folderContents.find('.bg-success').removeClass('bg-success');
        },

        initDragNDrop: function() {
                $('#filePlanTree').find('.folderNode').draggable(DroppableOption)
                $('#filePlanTree').find('.folderNode').droppable(FolderDroppableOption);
                $('#filePlanTree').find('.orgNode').droppable(OrganizationDroppableOption);
        },

        getfolderContents: function(orgRegNumber, folderId, path, description, archivalProfiles) {
            var url = "/folder?orgRegNumber="+orgRegNumber;
            if (folderId) {
                url = url + "&folderId="+folderId;
            }

            $.ajax({
                url         : url,
                type        : "GET",
                dataType    : 'json',
                success     : function (response) {
                    ArchiveList.buildResultList(response.archives);
                    $('#folderPath').text(path);
                    $('#folderDescription').html(description);
                },
                error       : function (response) {
                    gritter.show(response.responseText, false);
                }
            })

            this.getImportForm(orgRegNumber, folderId, archivalProfiles);
        },

        buildResultList: function(archives) {
            var template = $('#listTemplate').children('.archive');
            this.archivesOrder = [];

            this.folderContents.html('');
            $('#rightColumn').html('');

            if (archives.length) {
                $('#emptyFolderMessage').addClass('hide');
                $('#folderContentList').removeClass('hide');
            } else {
                $('#emptyFolderMessage').removeClass('hide');
                $('#folderContentList').addClass('hide');
            }

            for(i=0; i<archives.length; i++) {
                var archiveDiv = template.clone();
                var siblings = archiveDiv.attr('id', archives[i].archiveId)
                                         .find('.archiveName').text(archives[i].archiveName)
                                         .siblings('small');

                if (archives[i].originatorArchiveId) {
                    $(siblings[0]).children('i').text(archives[i].originatorArchiveId);
                }
                if (archives[i].depositDate) {
                    $(siblings[1]).text(archives[i].depositDate.substring(0, 19));
                }
                if (archives[i].archivalProfileName) {
                    $(siblings[2]).text(archives[i].archivalProfileName);
                }

                this.folderContents.append(archiveDiv);
                this.archivesOrder.push(archiveDiv);
                this.archivesList.push(archives[i]);

            }
        },
        
        getImportForm: function(orgRegNumber, folderId, archivalProfiles) {
            ArchiveForm.changeArchivalProfilesList(archivalProfiles);

            if (archivalProfiles.length < 1) {
                $('#importTabLink').hide();
                $('#folderTab').click();
                return;
            }

            $('#importTabLink').show();
            $('#archiveForm [name="filePlanPosition"]').val(folderId);
            $('#archiveForm [name="originatorOrgRegNumber"]').val(orgRegNumber);
        },

        refresh: function() {
            FilePlan.selectedNode.find('b:first').click();
        }
    }

    Archive = {
        archiveContentTemplate: $('#archiveContentTemplate').children('li'),

        getInfo: function(archiveId) {
            $.ajax({
                url         : "/archive/"+archiveId,
                type        : "GET",
                success     : function (response) {
                    $('#rightColumn').html(response);
                },
                error       : function (response) {
                    gritter.show(response.responseText, false);
                }
            })
        },
        getContent: function(archive) {
            $.ajax({
                url         : "/archiveContents/"+archive.attr('id'),
                type        : "GET",
                dataType    : 'json',
                success     : function (response) {
                    archive.find('.archiveContent').removeClass('hide').find('ul').html('');
                    Archive.showArchiveContent(archive.find('.archiveContent'), response.digitalResources, response.childrenArchives);
                },
                error       : function (response) {
                    gritter.show(response.responseText, false);
                }
            })
        },

        getResourceInfo: function(resource) {
            $.ajax({
                url         : "/documentInfo",
                type        : "GET",
                success     : function (response) {
                    $('#rightColumn').html(response);
                    DocumentInformation.load(resource.data('json'));
                },
                error       : function (response) {
                    gritter.show(response.responseText, false);
                }
            })
        },

        showArchiveContent: function(parent, digitalResources, childrenArchives) {
            for(i=0; i < childrenArchives.length; i++) {
                template = this.archiveContentTemplate.clone();

                template.children('span')
                        .children('i')
                        .addClass('fa fa-archive')
                        .siblings('span')
                        .addClass('childrenArchive')
                        .attr('id', childrenArchives[i].archiveId)
                        .html(childrenArchives[i].archiveName);

                BootstrapTree.addNode(parent, template);

                this.showArchiveContent(template, childrenArchives[i].digitalResources, childrenArchives[i].childrenArchives);
            }

            for(i=0; i < digitalResources.length; i++) {
                template = this.archiveContentTemplate.clone();

                template.children('span')
                        .children('i')
                        .addClass('fa fa-file-o')
                        .siblings('span')
                        .addClass('document')
                        .data('json', digitalResources[i])
                        .attr('id', digitalResources[i].resId)
                        .html(digitalResources[i].fileName);

                BootstrapTree.addNode(parent, template);
            }
        }
    }

    // List icon toggle
    $('#folderContentList').on('click', '.archiveSelection', function() {
        var checkbox = $(this);
        if (checkbox.hasClass('fa-square-o')) {
            checkbox.removeClass('fa-square-o').addClass('fa-check-square-o')
                    .closest('.archive').addClass('bg-info');
        } else {
            checkbox.removeClass('fa-check-square-o').addClass('fa-square-o')
                    .closest('.archive').removeClass('bg-info');
        }
    })

    $('#folderContentList').on('click', '.archiveContentButton', function() {
        var caret = $(this);
        if (caret.hasClass('fa-caret-right')) {
            $('#folderContentList').find('.fa-caret-down').click();
            caret.removeClass('fa-caret-right').addClass('fa-caret-down');
            Archive.getContent($(this).closest('.archive'));
        } else {
            caret.removeClass('fa-caret-down').addClass('fa-caret-right')
                 .closest('div').siblings('.archiveContent').addClass('hide');
        }
    })

    $('#folderContentList').on('click', '.selectAll', function() {
        var checkbox = $(this);
        if (checkbox.hasClass('fa-square-o')) {
            $('#folderContentList').find('.fa-check-square-o').click();
        } else {
            $('#folderContentList').find('.fa-square-o').click();
        }
    })

    // Actions on archives
    $('#folderContents').on('click', '.archiveName', function() {
        var archive = $(this).closest('.archive');
        var archiveId = archive.attr('id');
        ArchiveList.select(archive);
        Archive.getInfo(archiveId);
    })

    $('#folderContents').on('click', '.childrenArchive', function() {
        var parentArchive = $(this).closest('.archive');
        var archiveId = $(this).attr('id');
        ArchiveList.select(parentArchive);
        Archive.getInfo(archiveId);
    })

    $('#folderContents').on('click', '.document', function() {
        var parentArchive = $(this).closest('.archive');
        var resId = $(this).attr('id');
        ArchiveList.select(parentArchive);
        Archive.getResourceInfo($(this));
    })

    $('#importTabLink').on("click", function() {
        var parentArchiveId = $("#folderContentList").find(".bg-success").attr("id");
        $("#archiveForm [name='parentArchiveId']").val(parentArchiveId);
        $('#importTab').click();
    })
</script>