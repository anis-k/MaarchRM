<!--#
    This file is part of the maarchRM package.
    (c) Maarch Prosper DE LAURE <prosper.delaure@maarch.org>

    For the full copyright and license information, please view the LICENSE
    file that was distributed with this source code.
#-->
<div lang="en" data-translate-catalog="filePlan/messages">
    <div class="row" >
        <div id="filePlanMenu" class="btn-toolbar pull-right" role="toolbar">
            <div class="btn-group" role="group">
                <button type="button" class="btn btn-sm btn-default" id="addFolder" title="Add a new folder"><i class="fa fa-plus"/></button>
                <button type="button" class="btn btn-sm btn-default" id="editFolder" title="Edit folder"><i class="fa fa-edit"/></button>
                <button type="button" class="btn btn-sm btn-default" id="deleteFolder" title="Delete folder"><i class="fa fa-trash"/></button>
            </div>
        </div>
    </div>
    <?merge filePlan.bool() ?>
    <div id="filePlanTree" class="tree">
        <?merge filePlan ?>
        <ul>
            <?hinclude /filePlan/organizationNode.html ?>
        </ul>
    </div>
    <div id="folderNodeTemplate" class="hide">
        <?hinclude /filePlan/folderNode.html ?>
    </div>

    <?hinclude /filePlan/folderForm.html ?>
    <?hinclude /filePlan/movingComfirmationModal.html ?>
</div>

<style>
    .folderNode, .orgNode {
        position: relative;
    }
    .folderNode {
        padding: 0px !important; 
        min-width:150px !important;
    }
    .folderNode > b, .orgNode > b {
        font-size: 14px;
        cursor: pointer;
    }
    .folderNode > i {
        font-size: 24px;
    }
    #filePlanMenu {
        visibility: hidden
    }
</style>

<script>
    FilePlan = {
        tree: $('#filePlanTree'),
        selectedNode : null,
        select: function(e) {
            if (this.selectedNode && (this.selectedNode.attr('id') == e.attr('id'))) {
                return;
            }

            this.unselect();
            var span = e.children('span');
            if (span.hasClass('folderNode')) {
                FolderNode.select(span);
            } else {
                OrganizationNode.select(span);
            }

            $('#filePlanMenu').css('visibility', 'visible');
            this.selectedNode = e;
        },

        unselect: function() {
            if (!this.selectedNode) {
                return;
            }
            var span = this.selectedNode.children('span');
            if (span.hasClass('folderNode')) {
                FolderNode.unselect(span);
            } else {
                OrganizationNode.unselect(span);
            }
            $('#filePlanMenu').css('visibility', 'hidden');
            this.selectedNode = null;
        },

        addFolder: function() {
            var folder = {
                parentFolderId    : this.selectedNode.not('.organization').attr('id'),
                ownerOrgRegNumber : this.selectedNode.data('orgregnumber')
            }
            FolderForm.load(folder);
            $('#filePlanMenu').css('visibility', 'hidden');
        },

        editFolder: function() {
            var folder = {
                folderId          : this.selectedNode.attr('id'),
                name              : this.selectedNode.find('b:first').html(),
                description       : this.selectedNode.data('description'),
                parentFolderId    : this.selectedNode.data('parentid'),
                ownerOrgRegNumber : this.selectedNode.data('orgregnumber'),
                disabled          : this.selectedNode.data('disabled')
            }
            FolderForm.load(folder);
            $('#filePlanMenu').css('visibility', 'visible');
        },

        deleteFolder: function() {
            alert('Not yet implemented...');
        },

        addFolderNode: function(folder) {
            var template = $('#folderNodeTemplate').children('li').clone();
            template = this.fullUpFolderNode(folder, template);
            console.log(template);
            BootstrapTree.addNode(this.selectedNode, template);

            this.initDragNDrop();
            $('#filePlanMenu').css('visibility', 'visible');
        },

        editFolderNode: function(folder) {
            this.fullUpFolderNode(folder, $('#'+folder.folderId));
            $('#filePlanMenu').css('visibility', 'visible');
        },

        fullUpFolderNode: function(folder, node) {
            node.attr('id', folder.folderId)
                .data('path', this.selectedNode.data('path')+'/'+folder.name)
                .data('orgregnumber', folder.ownerOrgRegNumber)
                .data('parentid', folder.parentId)
                .data('description', folder.description)
                .data('disabled', folder.disabled)
                .children('span')
                .children('b').html(folder.name);

            return node;
        },

        initDragNDrop: function() {
            $('#filePlanTree').find('.folderNode').draggable(DroppableOption)
            $('#filePlanTree').find('.folderNode').droppable(FolderDroppableOption);
            $('#filePlanTree').find('.orgNode').droppable(OrganizationDroppableOption);
        }
    }

    FolderNode = {
        moveIn: function(e) {
            e.find('i')
             .css("font-size", "34px")
             .siblings()
             .css("font-size", "24px");
        },

        moveOut: function(e) {
            e.find('i')
             .css("font-size", "24px")
             .siblings()
             .css("font-size", "14px");
        },

        mouseenter: function(e) {
            if (e.css('font-size') != '24px') {
                e.addClass('label label-default');
            }
        },

        mouseleave: function(e) {
            if (!e.hasClass('label-warning')) {
                e.removeClass('label label-default');
            }
        },

        select: function(e) {
            e.find('b:first').removeClass('label-default').addClass('label-warning')
             .siblings('i').removeClass('text-primary').addClass('text-warning');

        },

        unselect: function(e) {
            e.find('b:first').removeClass('label label-default label-warning')
             .siblings('i').removeClass('text-warning').addClass('text-primary');
        }
    }

    OrganizationNode = {
        moveIn: function(e) {
            e.children('b').css('font-size', '18px');
        },

        moveOut: function(e) {
            e.children('b').css('font-size', '14px');
        },

        select: function(e) {
            e.removeClass('node-default').addClass('node-warning');
            $('#editFolder, #deleteFolder').prop('disabled', true);
        },

        unselect: function(e) {
            e.removeClass('node-warning').addClass('node-default');
            $('#editFolder, #deleteFolder').prop('disabled', false);
        }
    }

    DroppableOption = {
        revert : true,
        zIndex: 100
    }

    FolderDroppableOption = {
        over: function(event, ui) {
           FolderNode.moveIn($(this));
        },
        out: function(event, ui) {
           FolderNode.moveOut($(this));
        },
        drop: function(event, ui) {
            FolderNode.moveOut($(this));
            MovingConfirmationModal.show($(ui.draggable).closest('li'), $(this).closest('li'));
        }
    }

    OrganizationDroppableOption = {
        greedy : true,
        over: function(event, ui) {
           OrganizationNode.moveIn($(this));
        },
        out: function(event, ui) {
           OrganizationNode.moveOut($(this));
           
        },
        drop: function(event, ui) {
            OrganizationNode.moveOut($(this));
            MovingConfirmationModal.show($(ui.draggable).closest('li'), $(this).closest('li'));
        }
    }

    $('#app_maarchRM_main').ready(function() {
        BootstrapTree.init($('#filePlanTree'));
        FilePlan.initDragNDrop();
    })

    // Folder selection
    $('#filePlanTree').on('mouseenter', '.folderNode > b', function() { 
        FolderNode.mouseenter($(this));
    });
    $('#filePlanTree').on('mouseleave', '.folderNode > b', function() { 
        FolderNode.mouseleave($(this));
    })

    $('#filePlanTree').on('mouseenter', '.orgNode > b', function() { 
        OrganizationNode.moveIn($(this));
    });
    $('#filePlanTree').on('mouseleave', '.orgNode > b', function() { 
        OrganizationNode.moveOut($(this));
    })

    // File plan menu
    $('#addFolder').on('click', function(){ FilePlan.addFolder() })
    $('#editFolder').on('click', function(){ FilePlan.editFolder() })
    $('#deleteFolder').on('click', function(){ FilePlan.deleteFolder() })
</script>