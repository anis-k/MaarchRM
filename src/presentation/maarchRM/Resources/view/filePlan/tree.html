<!--#
    This file is part of the maarchRM package.
    (c) Maarch Prosper DE LAURE <prosper.delaure@maarch.org>

    For the full copyright and license information, please view the LICENSE
    file that was distributed with this source code.
#-->
<div lang="en" data-translate-catalog="filePlan/messages">
    <div class="row" >
        <div id="filePlanMenu" class="btn-toolbar pull-right" role="toolbar">
            <div class="btn-group" role="group">
                <button type="button" disabled class="btn btn-sm btn-default" id="addFolder" title="Add a new folder"><i class="fa fa-plus"/></button>
                <button type="button" disabled class="btn btn-sm btn-default" id="editFolder" title="Edit folder"><i class="fa fa-edit"/></button>
                <button type="button" disabled class="btn btn-sm btn-default" id="deleteFolder" title="Delete folder"><i class="fa fa-trash"/></button>
            </div>
        </div>
    </div>
    <?merge filePlan.bool() ?>
    <div id="filePlanTree" class="tree-l">
        <?merge filePlan ?>
        <ul>
            <?hinclude /filePlan/organizationNode.html ?>
        </ul>
    </div>
    <div id="folderNodeTemplate" class="hide">
        <?hinclude /filePlan/folderNode.html ?>
    </div>

    <?hinclude /filePlan/folderForm.html ?>
    <?hinclude /filePlan/movingComfirmationModal.html ?>
    <?hinclude /filePlan/supressionComfirmationModal.html ?>
    <?hinclude /filePlan/archiveAssignmentModal.html ?>
</div>

<style>
    .folderNode, .orgNode {
        position: relative;
    }
    .folderNode {
        padding: 0px !important; 
        min-width:150px !important;
    }
    .folderNode > b, .orgNode > b {
        font-size: 12px;
        cursor: pointer;
    }
    .folderNode > i {
        font-size: 20px;
    }

</style>

<script>
    FilePlan = {
        tree: $('#filePlanTree'),
        selectedNode : null,
        // hoverTimeout : null,
        select: function(e) {
            if (this.selectedNode && (this.selectedNode.attr('id') == e.attr('id'))) {
                return;
            }

            this.unselect();
            var span = e.children('span');
            if (span.hasClass('folderNode')) {
                FolderNode.select(span);
            } else {
                OrganizationNode.select(span);
            }

            this.selectedNode = e;
        },

        unselect: function() {
            if (!this.selectedNode) {
                return;
            }
            var span = this.selectedNode.children('span');
            if (span.hasClass('folderNode')) {
                FolderNode.unselect(span);
            } else {
                OrganizationNode.unselect(span);
            }
            this.selectedNode = null;
        },

        load: function(e) {
            this.select(e);

            var orgRegNumber = e.data('orgregnumber');
            var folderId = null;
            var path = '';
            var description = '';
            var profile = null;
            var locked = null;

            if (e.hasClass('organization')) {
                path = e.find('b:first').html();
                profile = e.data('archivalprofiles');
            } else {
                folderId = e.attr('id');
                path = e.data('path')
                description = e.data('description')
                profile = e.closest('.organization').data('archivalprofiles');
                locked = e.data('closed');
            }

            ArchiveFolderList.getfolderContents(orgRegNumber, folderId, path, description, profile, locked);
        },

        addFolder: function() {
            var folder = {
                parentFolderId    : this.selectedNode.not('.organization').attr('id'),
                ownerOrgRegNumber : this.selectedNode.data('orgregnumber')
            }
            FolderForm.load(folder);
        },

        editFolder: function() {
            var folder = {
                folderId          : this.selectedNode.attr('id'),
                name              : this.selectedNode.find('b:first').html(),
                description       : this.selectedNode.data('description'),
                parentFolderId    : this.selectedNode.data('parentid'),
                ownerOrgRegNumber : this.selectedNode.data('orgregnumber'),
                closed            : this.selectedNode.data('closed')
            }
            FolderForm.load(folder);
        },

        deleteFolder: function() {
            DeleteConfirmationModal.show();
        },

        addFolderNode: function(folder) {
            var template = $('#folderNodeTemplate').children('li').clone();
            template = this.fullUpFolderNode(folder, template);

            template.data('path', this.selectedNode.data('path')+'/'+folder.name)
            BootstrapTree.addNode(this.selectedNode, template);

            this.initDragNDrop();
        },

        editFolderNode: function(folder) {
            var folderNode = $('#'+folder.folderId);
            this.fullUpFolderNode(folder, folderNode);

            var path = folderNode.data('path');
            path = path.split('/');
            path[path.length-1] = folder.name;
            folderNode.data('path', path.join('/'));

            folderNode.find('b').click();
        },

        fullUpFolderNode: function(folder, node) {
            node.attr('id', folder.folderId)
                .data('orgregnumber', folder.ownerOrgRegNumber)
                .data('parentid', folder.parentId)
                .data('description', folder.description)
                .data('closed', folder.closed)
                .children('span')
                .children('b').html(folder.name);

            return node;
        },

        initDragNDrop: function() {
            $('#filePlanTree').find('.folder').draggable(DroppableOption)
            $('#filePlanTree').find('.folderNode').droppable(FolderDroppableOption);
            $('#filePlanTree').find('.orgNode').droppable(OrganizationDroppableOption);
        },
        
        getChildrenOrg : function() {
            var orgNode = FilePlan.selectedNode;
            if (!$(FilePlan.selectedNode).hasClass("organization")) {
                orgNode = $(FilePlan.selectedNode).closest(".organization");
            }

            return $(orgNode).find(".organization");
        }
    }

    FolderNode = {
        moveIn: function(e) {
            e.find('i')
             .css("font-size", "34px")
             .siblings()
             .css("font-size", "20px");

            if (e.closest('.folder').data('closed')) {
                e.find('i').removeClass('text-primary').addClass('text-danger');   
            }
        },

        moveOut: function(e) {
            e.find('i')
             .css("font-size", "20px")
             .addClass('text-primary')
             .removeClass('text-danger') 
             .siblings()
             .css("font-size", "12px");
            
        },

        mouseenter: function(e) {
            if (e.css('font-size') != '20px') {
                e.addClass('label label-default');
            }
        },

        mouseleave: function(e) {
            if (!e.hasClass('label-warning')) {
                e.removeClass('label label-default');
            }
        },

        select: function(e) {
            e.find('b:first').removeClass('label-default').addClass('label-warning')
             .siblings('i').removeClass('text-primary').addClass('text-warning');
            $('#editFolder, #deleteFolder, #addFolder').prop('disabled', false);

        },

        unselect: function(e) {
            e.find('b:first').removeClass('label label-default label-warning')
             .siblings('i').removeClass('text-warning').addClass('text-primary');
        }
    }

    OrganizationNode = {
        moveIn: function(e) {
            e.children('b').css('font-size', '18px');
        },

        moveOut: function(e) {
            e.children('b').css('font-size', '12px');
        },

        select: function(e) {
            e.removeClass('node-default').addClass('node-warning');
            $('#editFolder, #deleteFolder').prop('disabled', true);
            $('#addFolder').prop('disabled', false);
        },

        unselect: function(e) {
            e.removeClass('node-warning').addClass('node-default');
        }
    }

    DroppableOption = {
        revert : true,
        zIndex: 100,
        helper: "clone",
        delay: 100
    }

    FolderDroppableOption = {
        over: function(event, ui) {
            parent = $(this);
            FolderNode.moveIn(parent);
            /*
            FilePlan.hoverTimeout = setTimeout(function () {
                BootstrapTree.openNode(parent.closest('li'));
                })
            }, 800);
            */
        },
        out: function(event, ui) {
           FolderNode.moveOut($(this));
           // clearTimeout(FilePlan.hoverTimeout);
        },
        drop: function(event, ui) {
            FolderNode.moveOut($(this));

            if ($(ui.draggable).hasClass('folder')) {
                MovingConfirmationModal.show($(ui.draggable).closest('li'), $(this).closest('li'));
                
            } else if ($(ui.helper).hasClass('archiveHelper')) {
                ArchiveAssignmentModal.moveInFolder($(ui.helper).data('archives'), $(this));
            }
        }
    }

    OrganizationDroppableOption = {
        greedy : true,
        over: function(event, ui) {
           OrganizationNode.moveIn($(this));
        },
        out: function(event, ui) {
           OrganizationNode.moveOut($(this));
        },
        drop: function(event, ui) {
            OrganizationNode.moveOut($(this));

            if ($(ui.draggable).hasClass('folder')) {
                MovingConfirmationModal.show($(ui.draggable).closest('li'), $(this).closest('li'));

            } else if ($(ui.helper).hasClass('archiveHelper')) {
                if ($(this).closest('li').attr('id') != FilePlan.selectedNode.attr('id'))
                    ArchiveAssignmentModal.removeFromFolder($(ui.helper).data('archives'));
            }
        }
    }

    $('#app_maarchRM_main').ready(function() {
        BootstrapTree.init($('#filePlanTree'));
        FilePlan.initDragNDrop();
    })

    // Folder selection
    $('#filePlanTree').on('mouseenter', '.folderNode > b', function() { 
        FolderNode.mouseenter($(this));
    })
    $('#filePlanTree').on('mouseleave', '.folderNode > b', function() { 
        FolderNode.mouseleave($(this));
    })

    $('#filePlanTree').on('mouseenter', '.orgNode > b', function() { 
        OrganizationNode.moveIn($(this));
    })
    $('#filePlanTree').on('mouseleave', '.orgNode > b', function() { 
        OrganizationNode.moveOut($(this));
    })
    $('#filePlanTree').on('click', '.folderNode > b, .orgNode > b', function() {
        FilePlan.load($(this).closest('li'));
    })


    // File plan menu
    $('#addFolder').on('click', function(){ FilePlan.addFolder() })
    $('#editFolder').on('click', function(){ FilePlan.editFolder() })
    $('#deleteFolder').on('click', function(){ FilePlan.deleteFolder() })
</script>