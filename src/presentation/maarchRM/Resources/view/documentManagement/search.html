<!--#
    This file is part of the registeredMail package.
    (c) Maarch Alexis Ragot <alexis.ragot@maarch.org>

    For the full copyright and license information, please view the LICENSE
    file that was distributed with this source code.
#-->
<div class="container-fluid" data-translate-catalog="documentManagement/messages">
    <div class="page-header">
        <h1>
            <i class="fa fa-search"></i>
            Search documents
        </h1>
    </div>
</div>

<div class="container-fluid" lang="en" data-translate-catalog="documentManagement/messages">
    <div class="panel-group" id="accordionSearch">
        <div class="panel panel-default">
            <div class="panel-heading" data-toggle="collapse" data-parent="#accordionSearch" href="#collapseOne" style="cursor:pointer;">
                <h4 class="panel-title" style="float:left;">
                    Search form 
                </h4>
                <i class="fa fa-caret-down" style="float:right;"></i>
                <div style="clear:both;"></div>
            </div>
            <div id="collapseOne" class="well panel-collapse collapse in" style="margin-bottom: 0px">
                <form class="form-horizontal" id="document_searchForm">
                    <div class="col-md-12">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="control-label col-md-3">Identifiant</label>
                                <div class="col-md-8">
                                    <input type="text" class="form-control" id="identifiant" name="identifiant" placeholder="Identifiant"/>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="col-sm-3 control-label">Last copy</label>
                                <div class="btn-group col-sm-8" data-toggle="buttons">
                                    <label class="btn btn-default" title="Oui">
                                        <input type="radio" name="lastCopy" value="1"/> Oui
                                    </label>
                                    <label class="btn btn-default" title="Non">
                                        <input type="radio" name="lastCopy" value="0"> Non
                                    </label>
                                    <label class="btn btn-info active" title="Tout">
                                        <input type="radio" name="lastCopy" value="" checked> Tout
                                    </label>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="control-label col-md-3" for="puid">Format</label>
                                <div class="col-md-8">
                                    <input type="text" class="form-control" id="puid" name="puid" placeholder="File format" data-puid-selected=""/>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="col-sm-3 control-label">Copy</label>
                                <div class="btn-group col-sm-8" data-toggle="buttons">
                                    <label class="btn btn-default" title="Oui">
                                        <input type="radio" name="isCopy" value="1"/> Oui
                                    </label>
                                    <label class="btn btn-default" title="Non">
                                        <input type="radio" name="isCopy" value="0"> Non
                                    </label>
                                    <label class="btn btn-info active" title="Tout">
                                        <input type="radio" name="isCopy" value="" checked> Tout
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                    <br/>
                    <div class="clearfix">
                        <div class="col-md-12">
                            <button type="button" class="btn btn-primary col-md-offset-4 col-md-3" id="document_search" title="Search"><i class="fa fa-search">&nbsp;</i>Search</button>
                            <button type="button" class="btn btn-warning col-md-offset-1" id="document_resetForm" title="Reset"><i class="fa fa-refresh">&nbsp;</i>Reset</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <div class="container-fluid" id="document_searchResult"></div>
</div>

<script>
    
    $('#document_searchForm').on('click', 'label.btn', function() {
        var select = $(this);
        select.closest('.btn-group').find('.btn-info').removeClass('btn-info').addClass('btn-default');
        select.removeClass('btn-default').addClass('btn-info');
    });
    /* ----------------------------------------------------------------------------------------------------*/
    /* -- SEARCH FORM -- */
    $('#app_maarchRM_main').ready(function () {
        var typesSource = new Bloodhound({
            datumTokenizer: Bloodhound.tokenizers.obj.whitespace('puid'),
            queryTokenizer: Bloodhound.tokenizers.whitespace,
            remote: {
                url: '/digitalResource/format/find/%QUERY',
                rateLimitWait: 500
            },
            limit: 100
        });
        typesSource.initialize();

        // initialize typeahead
        $('#puid').typeahead(
                {
                    hint: true,
                    highlight: true,
                    minLength: 1
                },
        // data source contacts
        {
            name: 'format',
            displayKey: 'name',
            templates: {
                empty: function () {
                    return "<span class='well well-sm'>No format found</span>";
                },
                suggestion: function (type) {
                    var displayName = '[' + type['puid'] + '] ' + type['name'];
                    if (type['version'] != undefined) {
                        displayName += ' ' + type['version'];
                    }
                    var display = "<span>"
                            + "<span style='font-family:Helvetica, sans-serif;'>"
                            + displayName
                            + "</span>"
                            + "</span>";

                    return display;
                }
            },
            source: function (query, cb) {
                typesSource.get(query, function (suggestions) {
                    /*var i = suggestions.length
                    while (i--) {
                        if ($.inArray(suggestions[i].puid, boundFormats()) > -1)
                            suggestions.splice(i, 1);
                    }*/
                    cb(suggestions);
                });
            },
            skipCache: true
        }).on('typeahead:selected', function ($event, suggestion, source) {
            $("#puid").attr('data-puid-selected', suggestion["puid"]);
            $('#addFormat').removeClass('disabled');
        });
    });


    $('#app_maarchRM_main').keypress(function (e) {
        if (e.which != 13) {
            return;
        }
        // Prevent form submit
        e.preventDefault();
        if ($("#todo").is(':focus')) {
            $("#todo").click();

        } else {
            $("#document_search").click();
        }
    });

    $('#').on('click', function () {
        return;
        $(this).prop('disabled', true);
        $.ajax({
            type        : 'GET',
            url         : '/documentManagement/document',
            data        : null,
            dataType    : 'html',
            contentType : null,
            success     : function (response) {
            },
            error       : function (e) {
            }
        });
        $('#this').prop('disabled', false);
    });

    $('#document_search').on('click', function () {

       $(this).prop('disabled', true);
        $.ajax({
            type     : 'GET',
            url      : '/documentManagement/document/find',
            data     : serialize(),
            dataType : 'html',
            success  : function (response) {
                $('#document_searchResult').empty().html(response);
            },
            error    : function(e) {
            }
        });
        $(this).prop('disabled', false);
    });

    function serialize() {
        serializedObject = {
            identifiant : $("#identifiant").val(),
            puid : $("#puid").attr("data-puid-selected"),
            lastCopy : $("#document_searchForm").find('[name="lastCopy"]:checked').val(),
            isCopy : $("#document_searchForm").find('[name="isCopy"]:checked').val()
        }
        
        return serializedObject;
    }
    
    $("#document_resetForm").on("click", function () {
        $('#document_searchForm').find('input[type="text"]').val('');
        $('#puid').attr('data-puid-selected', "");
        $('#document_searchForm').find('input[type="radio"][value=""]').click();
        $('#document_searchResult').empty();
        
    });
</script>
