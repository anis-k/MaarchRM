<div id="contain" >
    <div class="container-fluid" data-translate-catalog="auth/messages">
        <div class="page-header">
            <h1>
                <i class="fa fa-users"></i>
                Edit service account
            </h1>
        </div>
    </div>
    <div class="container-fluid" data-translate-catalog="auth/messages">
        <?merge serviceAccount ?>
        <form>
            <div class="row">
                <div class="col-md-5">
                    <input type="hidden" name="accountId" id="serviceAccountId"/>
                    <div class="form-group">
                        <label class="control-label" for="accountName">Name<span style="color : red">*</span></label>
                        <div>
                            <input type="text" class="form-control" placeholder="Name" name="accountName" id="accountName" value=""/>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="control-label" for="serviceOrgId">Organization<span style="color : red">*</span></label>
                        <div>
                            <select class="form-control" name="orgId" id="serviceOrgId">
                                <option></option>
                                <?merge organizations ?>
                                <option value="[?merge .orgId ?]" name="orgId"><?merge .displayName ?></option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="control-label" for="serviceEnabled">Enabled</label>
                        <div>
                            <input type="checkbox" class="form-control" name="enabled" id="serviceEnabled" data-toggle="toggle"/>
                        </div>
                    </div>
                    <div class="clearfix pull-right">
                        <button type="button" class="btn btn-warning" id="cancelServiceAccount" title="Cancel">
                            <span class="fa fa-undo">&nbsp;</span>Cancel
                        </button>
                        <?merge serviceAccount.accountId.bool() ?>
                        <button type="button" class="btn btn-success" id="submitServiceAccount" title="Modify">
                            <span class="fa fa-save">&nbsp;</span>Save
                        </button>
                        <?merge serviceAccount.accountId.bool().not() ?>
                        <button type="button" class="btn btn-success" id="submitServiceAccount" title="Save">
                            <span class="fa fa-plus">&nbsp;</span>Add
                        </button>
                    </div>
                </div>
                <div class="col-md-6">
                    <ul class="nav nav-tabs nav-justified">
                        <li id="privilegesTabBtn" class="active"><a href="#privilegesTab" data-toggle="[?merge role.superadmin.then('', 'tab') ?]">Privileges</a></li>
                        <?merge serviceAccount.accountId.bool() ?>
                        <li id="generateTokenTabBtn" class=""><a href="#generateTokenTab" data-toggle="tab">Generate token</a></li>
                    </ul>
                    <div class="panel panel-primary" style="border-top-left-radius: 0; border-top-right-radius: 0; border-top: none;">
                        <div class="panel-body">
                            <div class="tab-content">
                                <?merge serviceAccount.accountId.bool() ?>
                                <div class="tab-pane fade in" id="generateTokenTab" >
                                    <h3>Generate token</h3>
                                    <div class="well">
                                        <button type="button" class="btn btn-link" id="tokenRegenerate" title="Generate token">
                                            <span class="fa fa-refresh">&nbsp;</span>Generate token
                                        </button>
                                        <div class="input-group col-xs-12">
                                            <textarea id="serviceToken" class="text-primary col-xs-12" rows="5" style="resize: none; resize: vertical" readonly=""></textarea>
                                        </div>
                                    </div>
                                </div>
                                <div class="tab-pane fade in active" id="privilegesTab" >
                                    <h3>Privileges</h3>
                                     <!-- it's use to clone -->
                                     <div style="display: none" id="privilegeExemple">
                                        <div class="input-group" name="privilegeURI">
                                            <input type="text" class="form-control" disabled=""/>
                                            <span class="input-group-btn">
                                                <button class="btn btn-danger" type="button" name="btnDeletePrvilege" title="Delete"><span class="fa fa-trash-o"></span></button>
                                            </span>
                                        </div>
                                    </div>
                                    <div class="form-horizontal" id="listPrivilege">
                                        <div class="input-group"> 
                                            <input type="text" class="form-control" id="inputPrivilegeURI">
                                            <span class="input-group-btn">
                                                <button class="btn btn-success" type="button" id="btnAddPrvilege" title="Add"><span class="fa fa-plus"></span></button>
                                            </span>
                                        </div>
                                        <?merge serviceAccount.servicePrivilege.bool() ?>
                                        <div>
                                            <?merge serviceAccount.servicePrivilege ?>
                                            <div class="input-group" name="privilegeURI">
                                                <input type="text" class="form-control" disabled="" value="[?merge .serviceURI ?]"/>
                                                <span class="input-group-btn">
                                                    <button class="btn btn-danger" type="button" name="btnDeletePrvilege" title="Delete"><span class="fa fa-trash-o"></span></button>
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </form>
    </div>
</div>
<script src="/public/dependency/html/js/bootstrap-toggle/bootstrap-toggle.js"></script>
<div style="display:none">
    <span id="empty_text">The fields with a star are required.</span>
    <span id="whiteSpace_text">The fields contain white spaces.</span>
    <span id="nullValue_text">The fields is empty.</span>
</div>
<script type="application/javascript">
    //save
    $("#submitServiceAccount").on("click", function(){
        var url = '/serviceAccount';
        var type = 'POST';

        if($('#serviceAccountId').val() != "") {
            type = 'PUT';
        }

        var param = new Object();
        var serviceAccount = new Object();
        
        serviceAccount.accountId = $("#serviceAccountId").val();
        serviceAccount.accountName = jQuery.trim($("#accountName").val());
        serviceAccount.displayName = serviceAccount.accountName;
        serviceAccount.emailAddress = '';
        //serviceAccount.orgId = $("#serviceOrgId").val();
        serviceAccount.enabled = false;
        orgId = $("#serviceOrgId").val();
        
        var servicesURI = new Array();
        $("#listPrivilege").find("[name=privilegeURI]").each(function(){
            servicesURI.push($(this).find("input").val());
        });
        
        if(serviceAccount.displayName == "" || orgId == "") {
             gritter.show($('#empty_text').html(),false);
             return false;
        }
        
        var param = {
            serviceAccount : serviceAccount,
            orgId : orgId,
            servicesURI : servicesURI
        };
        
        if ($("#serviceEnabled").prop("checked")) {
            serviceAccount.enabled = true;
        }
        
        ajax($(this), {
            url         : url,
            type        : type,
            data        : JSON.stringify(param),
            contentType : 'application/json',
            dataType    : "json",
            success  : function(response){
                gritter.show(response.message, response.status, response.errors);
                if(response.status) {
                    load("/serviceAccounts");
                };
            },
            error    : function(response) {
                gritter.show(response.responseJSON.message, response.responseJSON.status, response.responseJSON.errors);
            }
        });
    });
    
    //Add privilege
    $("#btnAddPrvilege").on("click", function(){
        var value = $("#inputPrivilegeURI").val();

        if (value == "") {
            gritter.show($('#nullValue_text').text(),false);
            return;
        }
        
        if (/\s/g.test(value)) {
            gritter.show($('#whiteSpace_text').text(),false);
            return;
        }

        $("#privilegeExemple").find("[name=privilegeURI]:first").clone().appendTo($("#listPrivilege")).find("input").val($("#inputPrivilegeURI").val());
        $("#inputPrivilegeURI").val("");
    });
    
    //Delete privilege
    $("#privilegesTab").on("click","[name=btnDeletePrvilege]", function(){
        $(this).closest("[name=privilegeURI").remove();
    });
    
    //Cancel
    $("#cancelServiceAccount").on("click", function(){
        load("/serviceAccounts");
    });
    
    //Cancel
    $("#tokenRegenerate").on("click", function(){
        ajax($(this), {
            url         : "/Serviceaccount/"+ $("#serviceAccountId").val() + "/token",
            type        : "GET",
            dataType    : "json",
            success  : function(response){
                $('#serviceToken').text(response.cookie);
                gritter.show(response.message, response.status);
            },
            error    : function(response) {
                gritter.show(response.responseJSON.message, response.responseJSON.status, response.responseJSON.errors);
            }
        });
    });

</script>