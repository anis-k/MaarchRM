<div data-translate-catalog="recordsManagement/messages">
    <?merge editMetadata.bool() ?>
    <div>
        <?merge modificationPrivilege.bool() ?>
        <div class="pull-right">
            <button type="button" class="btn btn-warning editMetadata"  data-archiveid="[?merge archive.archiveId ?]" title="Edit metadata"><i class="fa fa-edit">&nbsp;</i>Edit metadata</button>
        </div>
    </div>
    <div>
        <table id="archiveDescriptionTable" class="table table-condensed">
            <?merge archive.archiveName.bool() ?>
            <tr class="archiveName">
                <td><strong>Name</strong></td>
                <td><?merge archive.archiveName ?></strong></td>
            </tr>
            <?merge archive.originatorArchiveId.bool() ?>
            <tr class="originatorArchiveId">
                <td><strong>Originator archive identifier</strong></td>
                <td><?merge archive.originatorArchiveId ?></td>
            </tr>
            <?merge archive.originatingDate.bool() ?>
            <tr class="originatingDate">
                <td><strong>Originating date</strong></td>
                <td><?merge archive.originatingDate ?></td>
            </tr>
        </table>
    </div>
    <div id="metadata"
            data-archive-id="[?merge archive.archiveId ?]"
            data-originator-archive-id="[?merge archive.originatorArchiveId ?]"
            data-archiver-archive-id="[?merge archive.archiverArchiveId ?]"
            data-classification="[?merge archive.classificationLevel ?]"
            data-commentaire="[?merge archive.descriptionObject.Commentaires ?]">

        <span id="metadataForm_error" class="hide">Les métadonnées ne sont pas complètes.</span>
        <span class="hide" id="no_service_found_meta_text">Aucun service correspondant</span>
        <span class="hide" id="no_sorting_found_meta_text">Aucun classement correspondant</span>
        <span class="hide" id="long_comment_text">Le commentaire est trop long.</span>
    </div>
</div>
<style type="text/css">
    /*#archiveDescriptionTable tr td {
        white-space: normal !important;
        padding-left:10rem;
    }
    #archiveDescriptionTable tr th, #archiveDescriptionTable tr td {
        vertical-align: top;
    }*/
    /*#archiveDescriptionTable tr th {
        padding-left:1em;
    }/
    /*#metadata {
        padding-left:1em;
        padding-right:1em;
    }
    #metadata tr th {
        padding-left:1em;
    }
    #metadataTitle {
        border-top:1px solid #31708f;
        margin: 1.5em 0;
    }
    #metadata tr td {
        padding-left:1rem !important;
    }*/
    
</style>
<script type="text/javascript">
    var today = new Date();
    var yyyy = today.getFullYear();

    $('#archiveDescriptionForm').find('[name="annee"]').attr("max", yyyy);

    $('#archivalExport').on('click', function() {
        var archiveId = $('#metadata').data('archive-id');
        window.open('/Exportarchive/'+archiveId, '_blank');
    });

    MetadataForm = {
        metadata: $('#metadata'),
        form: $('#archiveDescriptionForm'),

        save: function() {
            archiveObject = {
                archiveId           : this.metadata.data('archive-id'),
                typeClassement      : this.form.find('[name="typeClassement"]').data('value'),
                numArchive          : this.form.find('[name="numArchive"]').val(),
                annee               : this.form.find('[name="annee"]').val(),
                archivalOrg         : this.form.find('[name="archivalOrg"]').data('value'),
                classificationLevel : this.form.find('[name="classificationLevel"]').val(),
                comment             : this.form.find('[name="commentaires"]').val()
            }

            if (archiveObject.comment.length >= 250) {
                gritter.show($('#long_comment_text').text(), false);
                return;

            }
            if (!archiveObject.archiveId || !archiveObject.typeClassement || !archiveObject.numArchive || !archiveObject.annee || !archiveObject.archivalOrg) {
                gritter.show($('#metadataForm_error').text(), false);
                return;
            }

            ajax($('#validateMetadata'), {
                type: 'PUT',
                url: '/recordsManagement/archive/metadata',
                data: JSON.stringify(archiveObject),
                dataType: 'json',
                contentType: 'application/json',
                success: function (response) {
                    gritter.show(response.message, true);
                    trigger("showDetails.archive", [archiveObject.archiveId]);
                }
            });
        },

        load: function() {
            archiveDescriptionTable = $('#archiveDescriptionTable');
            archiveDescriptionTable.addClass('hide');
            $('#archiveDescriptionFaits').addClass('hide');
            $('#archiveDescriptionForm').removeClass('hide');

            $('#archiveDescriptionForm').find('[name="archivalOrg"]').data('value', archiveDescriptionTable.find('.archivalOrg').data('value'));
            $('#archiveDescriptionForm').find('[name="archivalOrg"]').val(archiveDescriptionTable.find('.archivalOrg').text());
            $('#archiveDescriptionForm').find('[name="typeClassement"]').val(archiveDescriptionTable.find('.typeClassement').text());
            $('#archiveDescriptionForm').find('[name="typeClassement"]').data('value', archiveDescriptionTable.find('.typeClassement').data('value'));
            $('#archiveDescriptionForm').find('[name="numArchive"]').val(archiveDescriptionTable.find('.numArchive').text());
            $('#archiveDescriptionForm').find('[name="annee"]').val(archiveDescriptionTable.find('.annee').text());
            $('#archiveDescriptionForm').find('[name="classificationLevel"]').val($('#classificationLevel').data('value'));
            $('#archiveDescriptionForm').find('[name="commentaires"]').val(archiveDescriptionTable.find('.commentaires').text());
        },

        close: function() {
            $('#archiveDescriptionTable').removeClass('hide');
            $('#archiveDescriptionFaits').removeClass('hide');
            $('#archiveDescriptionForm').addClass('hide');
        }
    };

    $('#editMetadata').on('click', function() {
        MetadataForm.load();
    });

    $('#cancelMetadata').on('click', function(e) {
        e.preventDefault();
        MetadataForm.close();
    });

    $('#validateMetadata').on('click', function(e) {
        e.preventDefault();
        MetadataForm.save();
    });


    $('#metadata').ready(function() {
        $('#metadata').find('.serviceRef').typeahead(
            {
                hint: true,
                highlight: true,
                minLength: 2
            },
            {
                name: 'services',
                displayKey: 'name',
                templates: {
                    empty: function() {
                        return "<span class='well well-sm'>"+$('#no_service_found_meta_text').text()+"</span>";
                    },
                    suggestion: function(services) {
                        var display;
                        display =
                            "<span>"
                            + "<span style='font-family:Helvetica, sans-serif;'>"
                            + services.name
                            + "</span></span><br>";

                        return display;
                    }
                },
                source: function(query, cb) {
                    services.search(query, function(suggestions) {
                        cb(suggestions);
                    });
                },
                skipCache: true
            }
        ).on('typeahead:selected', function($event, suggestion, source) {
            $(this).data("value", suggestion.id);
        });

        $('#metadata').find('.sortingTypeRef').typeahead(
            {
                hint: true,
                highlight: true,
                minLength: 2
            },
            {
                name: 'sortingTypes',
                displayKey: 'name',
                templates: {
                    empty: function() {
                        return "<span class='well well-sm'>"+$('#no_sorting_found_meta_text').text()+"</span>";
                    },
                    suggestion: function(sortingTypes) {
                        var display;
                        display =
                            "<span>"
                            + "<span style='font-family:Helvetica, sans-serif;'>"
                            + sortingTypes.id
                            + '-'
                            + sortingTypes.name
                            + "</span></span><br>";

                        return display;
                    }
                },
                source: function(query, cb) {
                    sortingTypes.search(query, function(suggestions) {
                        cb(suggestions);
                    });
                },
                skipCache: true
            }
        ).on('typeahead:selected', function($event, suggestion, source) {
            $(this).data("value", suggestion.id);
        });
    });

</script>
