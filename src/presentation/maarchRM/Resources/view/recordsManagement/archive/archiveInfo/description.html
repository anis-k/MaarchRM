<div id="archiveDescriptiveMetadata" 
        data-translate-catalog="recordsManagement/messages" 
        data-archive-id="[?merge archive.archiveId ?]"
        data-archive-name="[?merge archive.archiveName ?]"
        data-originator-archive-id="[?merge archive.originatorArchiveId ?]"
        data-originating-date="[?merge archive.originatingDate ?]">

    <h4 class="text-center text-info archivalProfileName">
        <?merge archive.archivalProfileName ?>
        <?merge modificationPrivilege.bool() ?>
        <button type="button" class="btn btn-default btn-sm" id="editMetadata" title="Edit" style="border:0px solid transparent"><i class="fa fa-edit"></i></button>
    </h4>
    <table>
        <tr class="archiveName">
            <th title="Name">Name</th>
            <td title='[?merge archive.archiveName ?]'><?merge archive.archiveName ?></td>
        </tr>
        <tr class="originatorArchiveId">
            <th title="Originator archive identifier">Originator archive identifier</th>
            <td title='[?merge archive.originatorArchiveId ?]'><?merge archive.originatorArchiveId ?></td>
        </tr>
        <?merge archive.archiveArchiveId.bool() ?>
        <tr class="archiverArchiveId">
            <th title="Archive archive identifier">Archiver archive identifier</th>
            <td title='[?merge archive.archiverArchiveId ?]'><?merge archive.archiverArchiveId ?></td>
        </tr>
        <tr class="originatingDate">
            <th title="Originating date">Originating date</th>
            <td title='[?merge archive.originatingDate ?]'><?merge archive.originatingDate ?></td>
        </tr>
    </table>
    <div id="metadata">
    </div>
    <?merge acceptUserIndex ?>
    <div class="dropup col-xs-12" id="archiveCustomFieldAddBtn" style="display: none">
        <button type="button" class="btn btn-sm btn-link pull-right" title="Add field" data-toggle="dropdown">
            &nbsp;<i class="fa fa-plus">&nbsp;</i>Add field
        </button>
        <ul class="dropdown-menu pull-right metadataList" aria-labelledby="dLabel">
            <li><a href='#' class="addCustomField" data-type="text">Text</a></li>
            <li><a href='#' class="addCustomField" data-type="date">Date</a></li>
        </ul>
    </div>
    <button type="button" class="pull-right btn btn-default btn-sm" id="saveMetadata" title="Save" style="border:0px solid transparent; display: none"><i class="fa fa-check" style="color: green"></i></button>
    <button type="button" class="pull-right btn btn-default btn-sm" id="cancelMetadataEdition" title="Cancel" style="border:0px solid transparent; display: none" ><i class="fa fa-reply" style="color: red"></i></button>

    <div class="hide">
        <input id="inputArchiveName" name="archiveName" type="text" class="col-xs-12"/>
        <input id="inputOriginatorArchiveId" name="originatorArchiveId" type="text" class="col-xs-12"/>
        <input id="inputOriginatingDate" name="originatingDate" type="text" class="col-xs-12 datePicker"/>

        <input id="inputCustomNumericField" placeholder="Value" type="number" class="col-xs-12"/>

        <div  id="inputCustomBooleanField" class="btn-group" data-toggle="buttons">
            <label class="btn btn-xs btn-default">
                <input type="radio" name="defaultValue" autocomplete="off" value="0"><i class="fa fa-times"></i>
            </label>
            <label class="btn btn-xs btn-default active">
                <input type="radio" name="defaultValue" autocomplete="off" value="" checked>&nbsp;
            </label>
            <label class="btn btn-xs btn-default">
                <input type="radio" name="defaultValue" autocomplete="off" value="1"><i class="fa fa-check"></i>
            </label>
        </div>

        <input id="inputCustomBooleanField" placeholder="Value" type="text" class="col-xs-12"/>

        <input id="inputCustomField" placeholder="Value" type="text" class="col-xs-12"/>
        <input id="inputCustomLabel" placeholder="Label" type="text" class="col-xs-12" style="text-align: right"/>
        <span id="customFieldError_txt">Metadatas are incomplete.</span>
    </div>
</div>

<script type="text/javascript">
    var ArchiveInformation = {
        archiveId: $('#archiveDescriptiveMetadata').data('archive-id'),

        freeze: function() {
            var parameters = {
                archiveIds : ArchiveInformation.archiveId
            };
            
            $.ajax({
                type        : 'PUT',
                url         : "/recordsManagement/archive/freeze",
                data        : JSON.stringify(parameters),
                contentType : 'application/json',
                dataType    : 'json',
                success     : function (response) {
                    gritter.show(response.message, response.status, response.errors);

                    if (response.status) {
                        trigger("showDetails.archive", [ArchiveInformation.archiveId]);
                    }
                },
                error       : function (response) {
                    gritter.show(response.responseJSON.message, response.responseJSON.status, response.responseJSON.errors);
                }
            });
        },

        unfreeze: function() {
            var parameters = {
                archiveIds : ArchiveInformation.archiveId
            };
            
            $.ajax({
                type        : 'PUT',
                url         : "/recordsManagement/archive/unfreeze",
                data        : JSON.stringify(parameters),
                contentType : 'application/json',
                dataType    : 'json',
                success     : function (response) {
                    gritter.show(response.message, response.status, response.errors);

                    if (response.status) {
                        trigger("showDetails.archive", [ArchiveInformation.archiveId]);
                    }
                },
                error       : function (response) {
                    gritter.show(response.responseJSON.message, response.responseJSON.status, response.responseJSON.errors);
                }
            });
        },

        editManagementMetadata: function() {
            $('#editManagementMetadata').prop('disabled',true);
            $('#saveManagementMetadata').show();
            $('#cancelManagementEdition').show();

            if(!$('#managementInfo').hasClass('in')) {
                $('#managementInfo').addClass('in');
            }
            
            $('#retentionRuleSelect').show();
            $('#startDate').show();
            
            $("#retentionRuleCode").val($('#inputRetentionRuleCode').val());
            
            $('#finalDisposition').hide();
            $('#disposalDate').hide();
        },

        saveManagementMetadata: function() {
            var startDate = $('#archiveDescriptiveMetadata').find('.startDate').val();
            
            var retentionRule = {
                retentionStartDate : startDate,
                retentionDuration : $('#retentionRuleCode option:selected').data('duration'),
                finalDisposition : $('#retentionRuleCode option:selected').data('finaldisposition')
            };
            
            var parameters = {
                retentionRule : retentionRule,
                archiveIds: ArchiveInformation.archiveId
            };
            
            $.ajax({
                type        : 'PUT',
                url         : "/recordsmanagement/archive/retentionrule",
                data        : JSON.stringify(parameters),
                contentType : 'application/json',
                dataType    : 'json',
                success     : function (response) {
                    gritter.show(response.message, response.status, response.errors);

                    if (response.status) {
                        trigger("showDetails.archive", [ArchiveInformation.archiveId]);
                    }
                },
                error       : function (response) {
                    gritter.show(response.responseJSON.message, response.responseJSON.status, response.responseJSON.errors);
                }
            });
        },

        cancelMetadataEdition: function() {
            trigger("showDetails.archive", [ArchiveInformation.archiveId]);
        },

        editMetadata: function() {
            var archiveDescriptiveMetadata=$('#archiveDescriptiveMetadata');
            $('#editMetadata').prop('disabled',true);
            $('#saveMetadata').show();
            $('#cancelMetadataEdition').show();
            $('#archiveCustomFieldAddBtn').show();

            archiveDescriptiveMetadata.find('.archiveName')
                              .children('td')
                              .html('')
                              .append($('#inputArchiveName').val(archiveDescriptiveMetadata.data('archive-name')));
            
            archiveDescriptiveMetadata.find('.originatorArchiveId')
                              .children('td')
                              .html('')
                              .append($('#inputOriginatorArchiveId').val(archiveDescriptiveMetadata.data('originator-archive-id')));

            archiveDescriptiveMetadata.find('.originatingDate')
                              .children('td')
                              .html('')
                              .append($('#inputOriginatingDate').datepicker('setDate', archiveDescriptiveMetadata.data('originating-date')));

            $('#metadata').find('tr').each(function(i, e) {
                var label = $(e).children('th');
                var value = $(e).children('td');
                var customField = null;

                var customLabel = $("#inputCustomLabel").clone();
                customLabel.removeAttr('id').val(label.html()).attr('name', label.attr('name'));
                label.html('').append(customLabel);
                var booleanInput = null;

                switch(label.data('type')) {
                    case 'boolean' :
                        customField = $("#inputCustomBooleanField").clone();
                        var intValue = value.find('i').data('value');
                        booleanInput = customField.find('input[value="'+intValue+'"]');
                        break;
                    case 'number':
                        customField = $("#inputCustomNumericField").clone();
                        customField.val(value.html());
                        break;
                    case 'date': 
                        customField = $("#inputCustomField").clone();
                        customField.datepicker({
                            language:$('#wrapper').attr('lang'),
                            autoclose:true
                        }).datepicker('setDate', value.html());
                        break;
                    default :
                        customField = $("#inputCustomField").clone();
                        customField.val(value.html());
                }
                
                value.html('').append(customField.removeAttr('id'));

                if (booleanInput && booleanInput.length) {
                    booleanInput.click();
                }
            });

            $('#metadata').find('.archivalProfileField').find('th input').prop('disabled', true);
        },

        saveMetadata: function() {
            var descriptionFields = {};
            $('#metadata').find('tr').each(function(i, e) {
                var input = $(e).find('th > input');
                var valueInput = $(e).find('td input');
                var label = input.val();
                var name = input.attr('name');
                var type = $(e).find('th').data('type');

                switch (type) {
                    case "name" :
                    case "text" :
                        value = valueInput.val();
                        break;
                    case "date" :
                        value = valueInput.datepicker({ dateFormat: 'yy-mm-dd'}).val();
                        break;
                    case "number" :
                        value = parseInt(valueInput.val());
                        break;
                    case "boolean" :
                        if (valueInput.prop('checked')) {
                            inputValue = valueInput.parent('.active').find('input').val();
                            value = valueInput == 1 ? true : false;
                        }
                        break;
                    default:
                }

                if ($(e).hasClass('archivalProfileField')) {
                    descriptionFields[name] = value;
                } else if (label != '' && value != '') {
                    descriptionFields[label] = value;
                } else if (label == '' && value != '') {
                    gritter.show($('#customFieldError_txt').text(), false);
                    descriptionFields = false;
                    return;
                }
            });

            var parameters = {
                archiveId           : ArchiveInformation.archiveId,
                originatorArchiveId : $('#inputOriginatorArchiveId').val(),
                archiveName         : $('#inputArchiveName').val(),
                originatingDate     : $('#inputOriginatingDate').datepicker({ dateFormat: 'yy-mm-dd' }).val(), 
                description         : JSON.stringify(descriptionFields)
            };

            $.ajax({
                type        : 'PUT',
                url         : "/recordsmanagement/archive/metadata",
                data        : JSON.stringify(parameters),
                contentType : 'application/json',
                dataType    : 'json',
                success     : function (response) {
                    gritter.show(response.message, response.status, response.errors);

                    if (response.status) {
                        trigger("showDetails.archive", [ArchiveInformation.archiveId]);
                    }
                },
                error       : function (response) {
                    gritter.show(response.responseJSON.message, response.responseJSON.status, response.responseJSON.errors);
                }
            });

            $('#archiveCustomFieldAddBtn').hide();
        },

        addField : function(type) {
            var label = $('#inputCustomLabel').clone().val('').prop('disabled', false);
            var value = $('#inputCustomField').clone().val('');

            if(type == 'date') {
                value.datepicker({
                    language:$('#wrapper').attr('lang'),
                    autoclose:true
                });
            }

            var tr = $('<tr/>').append($('<th/>').append(label))
                               .append($('<td/>').append(value));

            $('#metadata').children('table').append(tr);
        }
    }

    $('#archiveDescriptiveMetadata').on('click','.freeze', function(){
        ArchiveInformation.freeze();
    });
    
    $('#archiveDescriptiveMetadata').on('click','.unfreeze', function(){
        ArchiveInformation.unfreeze();
    });
    
    $('#cancelManagementEdition, #cancelMetadataEdition').on('click', function(){
         ArchiveInformation.cancelMetadataEdition();
    });
    
    $('#editMetadata').on('click', function(){
        ArchiveInformation.editMetadata();
    });
    
    $('#archiveDescriptiveMetadata').on('click','.addCustomField',function(){
       ArchiveInformation.addField($(this).data('type'));
    });
    
    $('#saveMetadata').on('click', function(){
        ArchiveInformation.saveMetadata();
    });
</script>    
